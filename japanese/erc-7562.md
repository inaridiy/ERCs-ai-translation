---
original: 37c48b36d58dda4aef3240cd7acc74afe8ad55717063b0342d4bfe556c1d5e70
---

---
eip: 7562
title: アカウントアブストラクション検証範囲ルール
description: アカウントアブストラクションノードをサービス拒否攻撃から保護するために、検証EVM コードに課される一連の制限。
author: Yoav Weiss (@yoavw)、Dror Tirosh (@drortirosh)、Alex Forshtat (@forshtat)、Shahaf Nacson (@shahafn)
discussions-to: https://ethereum-magicians.org/t/erc-7562-account-abstraction-validation-scope-rules/16683
status: Draft
type: Standards Track
category: ERC
created: 2023-09-01
---

## 概要

このドキュメントでは、オフチェーンでブロックビルダーや独立したバンドラーによって強制される、アカウントアブストラクション取引(例えば[ERC-4337](./eip-4337) `UserOperation` やRIP-7560 (ネイティブアカウントアブストラクション))の検証コンテキストに課されるルールと、それぞれのルールの根拠について説明します。

## 動機

アカウントアブストラクションでは、取引の処理(検証、ガス支払い、実行)のための固定ロジックの代わりに、EVM コードによって実行されます。
アカウントにとっての利点は数知れません:
- 検証のアブストラクション化により、契約は異なる署名方式、マルチシグ設定、カスタムリカバリーなどを使用できます。
- ガス支払いのアブストラクション化により、サードパーティーによる簡単な登録、トークンでの支払い、クロスチェーンガス支払いが可能になります。
- 実行のアブストラクション化により、バッチ取引が可能になります。

これらはすべて、EOAアカウントモデルにはありません。

しかし、分散型ネットワークを維持するためには、取引が一度ネットワーク(メンプール)に送信されたら、必ず支払われるというルールに従う必要があります。これは、ネットワークに対する拒否サービス攻撃を防ぐためです。

EOAモデルでは、この暗黙のルールが自然に守られます: 有効な取引は、アカウントによる支払いなしでは無効にはなりません(より高い支払い取引を除く)。

この単純なルールにより、ネットワークの持続可能性とDoS保護が確保されます: 大量の取引によるネットワークへの攻撃は高価になり、ネットワークが混雑するほど高くなります。正当なユーザーはより高い料金を支払わなければならず、コストを避けるために操作を遅らせることができますが、攻撃者は膨大な(増加する)金額を支払い続けなければなりません。

アカウントアブストラクションシステムでも同じルールを維持したいので、ネットワークに対するDoS攻撃を高価なものにする必要があります。
そのために、以下のような検証ルールを追加します。

アカウントベースのこれらのコントラクトのインターフェースについては、ERC-4337およびRIP-7560の定義を参照してください。

このドキュメンテーションでは、スマートコントラクトアカウントによって作成された取引を「UserOperation」と呼び、[ERC-4337](./eip-4337)の用語に沿っています。
ただし、これらのルールは、検証と実行を区別し、EVM コードを使ってトランザクション検証を行うあらゆるアカウントアブストラクションフレームワークに適用されます。

## 仕様

### ルールの種類

2つのタイプのルールがあります:

- **ネットワーク全体のルール** ローカルメンプールに受け入れ、さらに伝播する前に、各 `UserOperation` に適用されるルール。
  これには、オペコードとストレージのルールが含まれます。
    - これらの検証ルールに違反した場合、`UserOperation` をドロップすべきです。
    - 2番目の検証フェーズ(バンドル送信前)でこれらの検証に失敗した場合、違反したエンティティの評判を低下させるべきです。
    - バンドラーは、検証ルールに違反した `UserOperation` を伝播してはいけません。そうしないと、他のバンドラーから「スパマー」と見なされ、切断されます。

- **ローカルルール**
  これらは、エンティティの評判に基づく「ソフト」なルールです。
  これらのルールは、バンドラー自身をスパム攻撃から保護するためのものです。
    - バンドラーはこのような `UserOperation` を検証せずにドロップすべきです。
    - バンドラーはこのような `UserOperation` を他のバンドラーに伝播してはいけません。
    - バンドラーは、他のバンドラーがそうしても「スパマー」と見なしてはいけません。

### 定数

| タイトル                                | 値                         | コメント                                                                         |
|--------------------------------------|-----------------------------|---------------------------------------------------------------------------------|
| `MIN_UNSTAKE_DELAY`                  | 86400                       | 1日                                                                           |
| `MIN_STAKE_VALUE`                    | チェーンごとに調整可能な値  | ネイティブトークンで約$1000相当                                           |
| `SAME_SENDER_MEMPOOL_COUNT`          | 4                           |                                                                                 |
| `SAME_UNSTAKED_ENTITY_MEMPOOL_COUNT` | 10                          |                                                                                 |
| `THROTTLED_ENTITY_MEMPOOL_COUNT`     | 4                           | スロットル対象のエンティティの `UserOperation` がメンプールに留まれる数 |
| `THROTTLED_ENTITY_LIVE_BLOCKS`       | 10                          | スロットル対象のエンティティの `UserOperation` がメンプールに留まれるブロック数 |
| `THROTTLED_ENTITY_BUNDLE_COUNT`      | 4                           |                                                                                 |
| `MIN_INCLUSION_RATE_DENOMINATOR`     | 100 (クライアント) \ 10 (バンドラー) |                                                                                 |
| `THROTTLING_SLACK`                   | 10                          |                                                                                 |
| `BAN_SLACK`                          | 50                          |                                                                                 |
| `BAN_OPS_SEEN_PENALTY`               | 10000                       |                                                                                 |
| `MAX_OPS_ALLOWED_UNSTAKED_ENTITY`    | 10000                       |

### 検証ルール

### **定義**:
1. **検証フェーズ**: 最大3つの検証フェーズがあります
    1. スマートコントラクトのデプロイ
    2. スマートコントラクトの検証
    3. ペイマスターの検証。
2. **エンティティ**: `UserOperation` によって明示的に指定されたコントラクト。
   `factory`、`paymaster`、`aggregator`、ステークされた `account` が含まれます。\
   各「検証フェーズ」は単一のエンティティに帰属します。\
   エンティティコントラクトはオンチェーンにコードを持っている必要があります。
3. **正規メンプール**: このドキュメントで定義されたルールは、ネットワーク上のすべてのバンドラーが共有する主要なメンプールに適用されます。
4. **ステークドエンティティ:** `MIN_STAKE_VALUE` 以上のロックされたステークと、`MIN_UNSTAKE_DELAY` 以上の引き出し遅延を持つエンティティ。
5. **関連ストレージ:** スマートコントラクトのストレージスロットは、以下の場合に `A` のアドレスに「関連」していると見なされます:
    1. スロットの値が `A` である
    2. スロットの値が `keccak(A||x)+n` として計算されており、`x` は `bytes32` 値、`n` は 0..128 の範囲の値である
6. **アドレスの使用**: 特定のアドレスのコードを任意の方法でアクセスすること。
   これは `*CALL` または `EXTCODE*` オペコードを使ってアドレスを実行することで行えます。

### 評判の定義
1. **opsSeen**: このエンティティを参照する一意の有効な `UserOperation` がこのバンドラーによって受信された回数の
   カウンター(1時間ごとに減少)。
   これには、着信RPC呼び出しやP2Pメンプールプロトコルを通じて受信したものが含まれます。

2. **opsIncluded**: このエンティティを参照する一意の有効な `UserOperation` が実際に含まれたバンドルに現れた回数の
   カウンター(1時間ごとに減少)。\
   この値の計算は `UserOperationEvents` に基づいており、このバンドラーによって以前 `opsSeen` としてカウントされた `UserOperation` のみが対象となります。
3. 両方の値は1時間ごとに `value = value * 23 // 24` として更新されます \
   つまり、4日後には1%まで減少します。
4. **inclusionRate**: `opsIncluded` と `opsSeen` の比率


### 評判の計算

`max_seen = opsSeen // MIN_INCLUSION_RATE_DENOMINATOR` という値を定義します。

各エンティティの評判状態は以下のように決定されます:

1. **BANNED**: `max_seen > opsIncluded + BAN_SLACK`
2. **THROTTLED**: `max_seen > opsIncluded + THROTTLING_SLACK`
3. **OK**: それ以外の場合

新しいエンティティは `OK` の評判から始まります。

これらのパラメータを理解するために、悪意のあるペイマスターが最大で `BAN_SLACK * MIN_INCLUSION_RATE_DENOMINATOR / 24` 個の非支払い `UserOperation` をネットワーク(P2Pネットワークのみ、ブロックチェーンではない)で処理させることができることに注意してください。

### 検証ルールの実行

1. ブロックビルダーやバンドラーは、`UserOperation` をメンプールに受け入れる前に、完全な検証を行う必要があります。
2. 検証フェーズ中、バンドラーはトレースを実行し、このドキュメントで定義されたすべてのルールを適用する必要があります。
3. バンドラーは、提出前にバンドル全体の完全な検証も行う必要があります。
4. 検証ルールにより、ステークされていないエンティティがバンドル検証を検出できないようになっています。
   ただし、悪意のあるステークドエンティティは、バンドル検証の実行を検出し、リバートを引き起こすことができます。
5. 失敗した `UserOperation` はバンドルから削除されるべきです。
6. リバートを引き起こしたステークドエンティティはアカウントアブストラクションルールに違反しており、「THROTTLED」とマークされるべきです。

### メンプール検証ルール

1. `UserOperation` は以下の情報とともにP2Pプロトコルで放送されます:
    1. `UserOperation` 自体
    2. この `UserOperation` が元々検証されたブロックハッシュ。
2. 他のバンドラーから `UserOperation` を受け取ると、受信バンドラーはローカルで検証する必要があります。
3. 受信した `UserOperation` は、以下のような合理的な静的チェックに失敗する可能性があります: \
   無効な形式、最小値以下の値、最近のブロックハッシュ以外で送信されたなど。\
   この場合、バンドラーはその特定の `UserOperation` をドロップしますが、接続は維持します。
4. バンドラーは、最後に含まれたバンドルのノンスに対して `UserOperation` をチェックする必要があります。\
   最近含まれたノンスを持つ `UserOperation` は静かにドロップする必要があります。
   この無効化は、ネットワークの競合条件によるものと考えられ、評判の変化は引き起こすべきではありません。
5. 受信した `UserOperation` が現在のブロックに対して失敗した場合:
    1. `UserOperation` が元々検証されたブロックに対して検証を再試行する。
    2. 成功した場合、静かに `UserOperation` をドロップし、接続を維持する。
    3. 失敗した場合、送信者を「スパマー」としてマークする

### オペコードルール
* 環境外の情報にアクセスするオペコードのブロック。
    * **[OP-011]** ブロックされるオペコード:
        * `ORIGIN` (`0x32`)
        * `GASPRICE` (`0x3A`)
        * `BLOCKHASH` (`0x40`)
        * `COINBASE` (`0x41`)
        * `TIMESTAMP` (`0x42`)
        * `NUMBER` (`0x43`)
        * `PREVRANDAO`/`DIFFICULTY` (`0x44`)
        * `GASLIMIT` (`0x45`)
        * `BASEFEE` (`0x48`)
        * `CREATE` (`0xF0`)
        * `INVALID` (`0xFE`)
        * `SELFDESTRUCT` (`0xFF`)
    *
* **[OP-012]** `GAS` (`0x5A`) オペコードは許可されますが、直後に `*CALL` 命令が続く場合のみです。それ以外の場合はブロックされます。\
      これは外部呼び出しに残りのガス全体を渡す一般的な方法で、実際の値がすぐにスタックから消費されるため、他のオペコードでアクセスできません。
    * **[OP-13]** 「未割り当て」のオペコード。
* **[OP-020]** 「ガス切れ」によるリバートは禁止されています。ガス制限や現在のコールスタック深さが「漏洩」する可能性があるためです。
* コントラクト作成:
    * **[OP-031]** `CREATE2` は展開フェーズで正確に1回許可され、「送信者」アドレスのコードをデプロイする必要があります。
* コードのないアドレスへのアクセスは禁止されています:
    * **[OP-041]** `EXTCODE*` および `*CALL` オペコードの場合。
    * **[OP-042]** 例外: 「送信者」アドレスへのアクセスは許可されます。
      これは展開フェーズの `factory` コードでのみ可能です。
* `EntryPoint` アドレスへの許可されたアクセス:
    * **[OP-051]** `EXTCODESIZE ISZERO` を呼び出すことができます\
      このパターンは、`depositTo` 関数を呼び出す前に宛先にコードがあるかどうかを確認するために使用されます。
    * **[OP-052]** `sender` または `factory` から任意の値で `depositTo(sender)` を呼び出すことができます。
    * **[OP-053]** `sender` から任意の値でフォールバック関数を呼び出すことができます。
    * **[OP-054]** `EntryPoint` への他のアクセスは禁止されています。
* `*CALL` オペコード:
    * **[OP-061]** `value` を持つ `CALL` は禁止されています。例外は上記の `EntryPoint` への呼び出しのみです。
    * **[OP-062]** プリコンパイル:
        * ネットワークで受け入れられた既知のプリコンパイルのみを許可し、ブロックチェーンの状態や環境にアクセスしないものとする。
        * コアプリコンパイル 0x1 .. 0x9
        * RIP-7212 sec256r1 プリコンパイル(ネットワークが受け入れた場合)
* **[OP-070]** [EIP-1153](./eip-1153)で定義された一時的なストレージスロットは、`TLOAD` (`0x5c`) および `TSTORE` (`0x5d`) オペコードを使ってアクセスされますが、永続的なストレージ(SLOAD/SSTORE)と同様に扱われます。
* **[OP-080]** `BALANCE` (`0x31`) および `SELFBALANCE` (`0x47`) は、ステークドエンティティからのみ許可され、それ以外はブロックされます。


### コードルール

* **[COD-010]** 最初の検証と2番目の検証の間に、訪問したアドレス、エンティティ、または参照ライブラリの `EXTCODEHASH` 値を変更してはいけません。\
  コードが変更された場合、`UserOperation` は無効と見なされます。

### ストレージルール

各フェーズ内の `SLOAD` および `SSTORE`(および `TLOAD`、`TSTORE`)命令によるストレージアクセスは以下のように制限されます:

* **[STO-010]** 「アカウント」ストレージへのアクセスは常に許可されます。
* 外部(非エンティティ)コントラクトのアカウントに関連するストレージへのアクセスは、以下のいずれかの場合に許可されます:
    * **[STO-021]** アカウントがすでに存在する場合。
    * **[STO-022]** `initCode` があり、`factory` コントラクトがステークされている場合。
* エンティティ(`paymaster`、`factory`)がステークされている場合、以下も許可されます:
    * **[STO-031]** エンティティ自身のストレージへのアクセス。
    * **[STO-032]** 任意の非エンティティコントラクトのエンティティに関連するストレージスロットの読み書きアクセス。
    * **[STO-033]** 任意の非エンティティコントラクトのストレージの読み取りアクセス。

### ローカルルール

ローカルストレージルールは、バンドリング時のサービス拒否攻撃からバンドラーを保護するためのものです。メンプールの伝播には影響せず、バンドラーが「スパマー」とマークされる原因にはなりません。
* **[STO-040]** `UserOperation` は、メンプール内の別の `UserOperation` の「アカウント」として使用されているエンティティアドレス(`factory`/`paymaster`/`aggregator`)を使用してはいけません。\
  つまり、`Paymaster` および `Factory` コントラクトは実際の「アカウント」コントラクトにはなれません。
* **[STO-041]** `UserOperation` は、メンプール内の別の `UserOperation` の「送信者」であるコントラクトの、自身のアカウントまたはステークドエンティティに関連するストレージを使用してはいけません。

### 一般的な評判ルール

以下の評判ルールは、すべてのステークドエンティティとステークされていないペイマスターに適用されます。特に指定がない限り、これらのルールはこれらのすべてのエンティティに適用されます。

* **[GREP-010]** `BANNED` アドレスはメンプールに許可されません。\
  また、このアドレスを参照するすべての既存の `UserOperation` はメンプールから削除されます。
* **[GREP-020]** `THROTTLED` アドレスは以下に制限されます:
    * メンプールに `THROTTLED_ENTITY_MEMPOOL_COUNT` 以下のエントリ。
    * バンドルに `THROTTLED_ENTITY_BUNDLE_COUNT` 以下の `UserOperation`。
    * `THROTTLED_ENTITY_LIVE_BLOCKS` ブロック以内にメンプールに留まることができます。
* **[GREP-040]** エンティティがバンドル作成に失敗した場合、`opsSeen` を `BAN_OPS_SEEN_PENALTY` に設定し、`opsIncluded` をゼロにして、`BANNED` とされます。

### ステークドエンティティの評判ルール

* **[SREP-010]** 「正規メンプール」は、`MIN_STAKE_VALUE` を持ち、`MIN_UNSTAKE_DELAY` の引き出し遅延を持つエンティティを定義します。
* **[SREP-020]** GREP-010に移動
* **[SREP-030]** GREP-020に移動
* **[SREP-040]** `OK` のステークドエンティティは、評判ルールによる制限を受けません。
    * メンプールに無制限の数を含めることができます。
    * バンドルに無制限の数を含めることができます。
* **[SREP-050]** GREP-040に移動

### エンティティ固有のルール

* **[EREP-010]** 各 `paymaster` について、このペイマスターを使用する `UserOperation` が消費できる総ガスを管理する必要があります。
    * 新しい `UserOperation` を含めた場合の最大総ガスコストが、現在のガス価格での `paymaster` の預金を超える場合は、`UserOperation` をメンプールに追加しないでください。
* **[EREP-011]** 削除
* **[EREP-015]** `paymaster` は、factory またはアカウントの失敗時に opsSeen の増加を受けるべきではありません
    * バンドルに含める前の2番目の検証を実行する際に、`UserOperation` がfactoryまたはアカウントのエラー(FailOpリバートまたは検証ルール)により失敗した場合、paymaster の opsSeen 有効値を1減らす必要があります。
* **[EREP-020]** ステークされたfactoryは、アカウントがルールを破った場合の「責任」を負います。\
  つまり、`initCode` を持つ `UserOperation` の `validateUserOp()` が何らかの理由で拒否された場合、factoryがこの失敗の原因であると見なされ、その評判に影響します。
* **[EREP-030]** ステークされたアカウントは、ステークされていても他のエンティティ(`paymaster`、`aggregator`)の失敗について責任を負います。
* **[EREP-040]** `aggregator` はストレージ使用量に関係なく、ステークされている必要があります。
* **[EREP-050]** 削除

### ステークされていないペイマスターの評判ルール

* 定義:
    * **`opsSeen`、`opsIncluded`、および評判計算** は上記で定義されています。
    * エンティティの `UnstakedReputation` は、メンプールでこのエンティティを使用できる最大エントリ数を決定します。
    * `opsAllowed` は、ステークされていないエンティティに対する評判ベースの計算で、メンプールに持つことができる `UserOperation` の数を表します。
    * ルール:
        * **[UREP-010]** ステークされていない送信者は、メンプールに `SAME_SENDER_MEMPOOL_COUNT` 以下の `UserOperation` しか持つことができません。
        * **[UREP-011]** ステークされた送信者は、[ステークドエンティティの評判ルール](#ステークドエンティティの評判ルール)によってのみ制限されます。
        * **[UREP-020]** スロットル/バン対象ではないステークされていないペイマスターの場合: \
          `opsAllowed = SAME_UNSTAKED_ENTITY_MEMPOOL_COUNT + inclusionRate * min(opsIncluded, MAX_OPS_ALLOWED_UNSTAKED_ENTITY)`.
        * これは新しいエンティティのデフォルトの `SAME_UNSTAKED_ENTITY_MEMPOOL_COUNT` です
        * **[UREP-030]** 削除

### 代替メンプールルール

代替メンプールは、バンドラーが正規メンプールに加えて選択できる合意済みのルールです。
代替メンプールの「トピック」は一意の識別子です。慣例として、このトピックはこの代替メンプールの仕様を記述したクリアテストとYAMLファイルのIPFSハッシュです。

* **[ALT-010]** バンドラーはP2Pプロトコルを介して代替メンプールの「トピック」をリッスンします。
* **[ALT-020]** 代替メンプールのルールは、正規ルールに違反した場合にのみチェックされます
    * つまり、上記の正規ルールに従って検証された場合、それは代替メンプールの一部とは見なされません。
*  **[ALT-021]** そのような `UserOperation`(正規ルールに違反したもの)は、すべての「代替メンプール」に対してチェックされ、それらすべての代替メンプールの一部と見なされます。
* **[ALT-030]** バンドラーは、共有する代替メンプールの数に関係なく、`UserOperation` を他のバンドラーに1回しか転送してはいけません。\
  受信バンドラーは `UserOperation` を検証し、上記のルール(および登録された代替メンプール)に基づいて、どの代替メンプールに伝播するかを決定します。
* **[ALT-040]** エンティティの opsInclude と opsSeen は代替メンプールごとに保持されます。つまり、あるエンティティが1つのメンプールでスロットル(またはバン)されている一方で、別のメンプールでは活動的である可能性があります。

### 代替メンプールの評判

代替メンプールは、正規メンプールに参加しているのと同じバンドラーによって提供されますが、ルールを変更し、サービス拒否攻撃のベクトルを導入する可能性があります。これらが正規メンプールや他の代替メンプールを破壊するのを防ぐため、各メンプールに対して評判が管理されます。 
無効化が多すぎる代替メンプールはスロットル化され、攻撃の範囲が制限され、他のメンプールの作業を続けられるようになります。

* **[AREP-010]** 各代替メンプールは、エンティティのように「opsSeen」と「opsIncluded」を管理します。opsSeen は、この代替メンプールの一部と見なされた後の `UserOperation` の初期検証後にインクリメントされます。
  「opsIncluded」は、このUserOperationがオンチェーンに含まれた(このバンドラーによるか、別のバンドラーによるか)後にインクリメントされます。
* **[AREP-020]** 代替メンプールは、[評判の計算](#評判の計算)に基づいて
`THROTTLED` になります。
* **[AREP-030]** 削除

## 根拠

EOAによって開始されたすべての取引には、Ethereumブロックチェーンの現在の状態に対して有効であることを確認する暗黙の検証フェーズがあります。
ノードによって取引が有効と確認されると、同じEOAによる別の取引のみが、最初の取引を無効にするようにEthereum状態を変更できます。

一方、アカウントアブストラクションでは、任意のEVM コードを含む検証と、ストレージへの依存も可能になります。
つまり、関係のない `UserOperation` や取引によって、お互いが無効になる可能性があります。

これに対処しないと、有効な `UserOperation` のメンプールを維持し、有効なバンドルを生成することが計算的に不可能になり、DoS攻撃の対象になります。

このドキュメントでは、バンドラーがメンプールに `UserOperation` を受け入れる前に適用できる検証ルールのセットを定義しています。

### 高レベルの目的

この仕様の目的は、外部ソースからの受信 `UserOperation` を処理する際の、ノード(バンドラーまたはブロックビルダー)間のコンセンサスを定義することです。
この `UserOperation` の外部ソースは、エンドユーザーノード(RPC経由)または P2P ネットワーク上の別のノードです。

このプロトコルは「スパム」を検出しようとします - これは、オンチェーンに含めることができない(したがって支払えない) `UserOperation` の大量のバーストです。
ネットワークは、このようなスパマーノードからの要求を抑制することで保護されます。

ネットワーク上のすべてのノードは「スパム」の定義を同じにする必要があります。そうしないと、ある種の `UserOperation` を受け入れ、それらを伝播するノードと、それらを「スパム」と見なすノードがいる場合、「寛容な」ノードが「スパマー」と見なされ、ネットワークが事実上分割されてしまいます。

### UserOperationの処理フロー

- まず、`UserOperation` が受信されます - RPC経由(単一のアプリケーションに代わって送信された)、または P2P プロトコルから別のメンプールノードから。
- ノードは `UserOperation` の検証を行い、メモリメンプールに追加し、ピアに送信します。
- 最後に、ブロックを構築する際、ノードはメンプールから `UserOperation` を収集し、バンドルとしての2番目の検証を実行し、次のブロックに送信します。

### ブロック作成前の2番目の検証の必要性

通常のEthereum取引は、同じノンスを持つ別の取引が受信された場合、メンプールで無効になる可能性があります。その他の取引は、最初のものを置き換えるためにガス代を増やす必要があったので、「含まれるためには支払う必要がある」というルールを満たしていました。
コントラクトベースのアカウントでは、`UserOperation` の有効性が変更可能な状態に依存するため、以前有効だった `UserOperation` が別の取引によって無効になる可能性があるので、ブロックに含める前に再チェックする必要があります。

### オペコードを制限する根拠:

- 検証はオフチェーンで行われ、ブロックを作成する前に行われます。一部のオペコードは、ブロックを作成する際にのみ知られる情報にアクセスします。
- これらのオペコードを `UserOperation` の検証中に使用すると、オフチェーンでは成功するが、オンチェーンでは常にリバートする検証ルールが簡単に作成でき、DoS攻撃の原因となります。
- 単純な例は `require block.number==12345` です。 `UserOperation` の検証時や、メンプールへの追加時には有効ですが、後でブロックに含めようとすると無効になります。

### ストレージアクセスを制限する根拠

- `UserOperation` の検証が重複しないようにする必要があります。そうしないと、単一のストレージ変更で、メンプール内の多数の `UserOperation` を簡単に無効にできてしまいます。アカウント自体に関連するストレージへのアクセスに制限することで、バンドルに各アカウントの単一の `UserOperation` を確実に含めることができます。
- (バンドラーは同じアカウントの複数の `UserOperation` をバンドルに含めることができますが、最初に一緒に検証する必要があります)

### ステークの要求の根拠

グローバルに使用されるコントラクト(ペイマスター、ファクトリー)にアカウントに関連しないストレージの使用を許可したいが、メンプールをスパムするのを防ぎたいと思っています。
コントラクトが2番目の検証で多くの `UserOperation` を失敗させる場合、メンプールでの使用を抑制することができます。
そのようなコントラクトにステークを要求することで、悪意のあるエンティティを大量に作成してスパム攻撃を続けるシビル攻撃を防ぐことができます。

検証ルールに従うことで、スパム `UserOperation` を引き起こすコントラクトを検出し、抑制することができます。
ステークは、そのような悪意のあるエンティティを素早く再作成するのを防ぐために必要です。
ステークは決して没収されることはありません(オフチェーンの検出にのみ使用されるため)が、一定期間ロックされるため、そのような攻撃はより高価になります。


### 「大量無効化攻撃」の定義

初期検証に合格し、ノードによって受け入れられ、他のバンドラーのメンプールにさらに伝播された多数の `UserOperation` が、後に無効となり、ブロックに含められなくなるような一連の行動は、「大量無効化攻撃」と見なされます。

そのような攻撃には3つの方法があります:

1. 初期検証は通過するが、バンドル作成時の再検証に失敗する `UserOperation` を送信する。
2. 個別には有効な `UserOperation` を送信するが、まとめてバンドルすると無効になる。
3. 有効な `UserOperation` を送信し、それらを無効にするようにネットワークの状態を「先行」して変更する。この「先行」は経済的に実行可能でなければなりません。

このような攻撃を防ぐために、我々は検証コードを「サンドボックス化」しようとしています。
他の `UserOperation` から、ストレージの外部変更から、現在のブロックタイムスタンプなどの環境情報から、検証コードを分離します。

### 「大量無効化攻撃」とは見なされないもの

受信ノードのメンプールに入る前に失敗した `UserOperation` は、攻撃とは見なされません。ノードはWeb2のセキュリティ対策を適用し、APIキー、送信元IPアドレスなどに基づいて要求を抑制することが期待されています。
RPCノードは、検証コストのかかる無効な取引でスパムされるのを防ぐために、すでにそうしています。
P2Pノードにも(適用すべき)スコアリングメカニズムがあり、スパマーノードを判断できます。

また、N個の `UserOperation` の無効化のコストがN*Xであり、Xが十分に大きい場合は、経済的に実行可能な攻撃とは見なされません。

- 無効化を引き起こす最小の変更はストレージ変更(5kガス)
- ノードが1ブロックあたり2000個の無効 `UserOperation` を処理できると仮定すると、DoS攻撃のコストは1ブロックあたり10Mガスです。
- この値は高いですが、さらなる対策を講じて、そのような攻撃をより高価なものにします。

## セキュリティ上の考慮事項

このドキュメントでは、バンドラー自身(およびメンプール全体のネットワーク)を拒否サービス攻撃から保護するために、バンドラーが取るべきセキュリティ上の考慮事項について説明しています。

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。