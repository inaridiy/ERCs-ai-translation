---
original: 3dfed40df424f3fbc0dfd86dbb71777567944d050462ce18fa5bde4e1119a60e
---

---
eip: 7066
title: ERC-721のロック可能な拡張機能
description: ロッカーとアプローブを使用したERC-721のロック機能のインターフェース
author: Piyush Chittara (@piyush-chittara), StreamNFT (@streamnft-tech), Srinivas Joshi (@SrinivasJoshi)
discussions-to: https://ethereum-magicians.org/t/eip-7066-lockable-extension-for-erc721/14425
status: Final
type: Standards Track
category: ERC
created: 2023-05-25
requires: 165, 721
---

## 概要

[ERC-721](./eip-721.md)の拡張機能として、このスタンダードはNFTに`ロック`機能を組み込み、売却や転送を防ぐことができます。トークンの`オーナー`は、トークンを`ロック`し、ロック解除の権限を持つ`ロッカー`アドレス(EOAまたはコントラクト)を設定できます。オーナーは、`tokenId`に対する`承認`を提供することで、資産をロックする機能を持つこともできます。トークンは`承認`されたアドレスによってもロックできます。その際、ロッカーとしてそのアドレスが指定されます。トークンの転送時には、これらの権限が消去されます。

## 動機

[ERC-721](./eip-721.md)は、NFTに対する前例のない需要の高まりを引き起こしました。しかし、この大きな成功にもかかわらず、NFT経済は所有者のウォレットに留まるため、二次流動性が低いという問題に悩まされています。この流動性の課題に取り組むプロジェクトはありますが、参加するNFTをプロジェクトのコントラクトに転送する必要があるため、以下のような不便さやリスクが生じます。

- 効用の喪失: NFTをエスクローアカウントに転送すると、オーナーの直接管理下から外れるため、NFTの効用価値が低下します。
- 合成性の欠如: NFTオーナーがローンの活用やアセットのレンタルなど、さまざまな金融ツールにアクセスできれば、より効率的な市場を生み出すことができます。合成性は、より効率的な市場を創出するための欠けていた要素です。
- スマートコントラクトの脆弱性: NFTは、依存しているスマートコントラクトのバグや脆弱性により、紛失や盗難のリスクにさらされています。

上述の問題は、ユーザーエクスペリエンス(UX)を損なっています。そこで、私たちは[ERC-721](./eip-721.md)スタンダードに、ネイティブのロック機能を実装することを提案します。
NFTをスマートコントラクトに転送するのではなく、自己管理下で安全に保管しつつロックすることができます。
ロック期間中は、NFTの転送が制限されますが、その他の特性は変わりません。
NFTオーナーは、NFTの効用を引き続き活用できます。

NFTには、オーナーのウォレット内に留まる必要があるユースケースが多数あります。Discordサーバーへのアクセス権限の承認や、プレイ・トゥ・アーン(P2E)ゲームでのNFT活用など、オーナーはローン期間中もこれらの機能を自由に行えるべきです。不動産オーナーが抵当に入った家に住み続けたり、個人ローンを組んだり、賃貸収入を得たりできるのと同様に、これらの機能をNFTオーナーにも提供することで、NFT経済にさらに多くの投資家を呼び込むことができます。

ロック可能なNFTは、以下のようなユースケースを可能にします:

- NFTを担保とするローン: NFTをレンディングプロトコルのコントラクトにロックすることなく、担保として活用できます。代わりに、NFTの効用を享受しながら、オーナーのウォレット内でロックできます。
- 担保不要のNFTレンタル: 大きな担保を必要とせずに、NFTを一定の料金で借りることができます。借り手はNFTを使用できますが、転送はできません。これにより、貸し手の安全性が確保されます。借り入れサービスのコントラクトは、借り入れ期間が終了すると自動的にNFTを貸し手に返します。
- 後払い(BNPL): 買い手はロックされたNFTを受け取り、即座に使い始めることができます。ただし、全額支払いが完了するまでNFTを売却することはできません。支払いが完了しない場合、NFTは売り手に返却され、手数料が課されます。
- 合成性: 複数の金融ツールにアクセスすることで、流動性を最大化できます。NFTに対してローンを組み、レンタルに出して受動的な収入を得るといったことが可能です。
- 一次販売: NFTを部分払いで購入し、オーナーが収集の進捗に満足したら、残額を支払うことができます。
- ソウルバウンド: 組織は`ロッカー`を自己割り当てしてNFTをミントし、ユーザーに送信してロックできます。
- 安全性: 独占的なブルーチップNFTを安全かつ便利に使用できます。ロック可能な拡張機能により、オーナーはNFTをMetaMaskに保管し、簡単に使用できます。一方で、コールドウォレットへのアクセスがなければ、ハッカーはNFTを転送できません。これにより、NFTの安全性が確保されます。

この提案は、他のロック提案とは以下の点で異なります:

- この実装では、`lock`と`unlock`の最小限の実装を提供しています。時間制限付きのロック解除などの条件は優れたアイデアですが、トークンコントラクトの一部として実装する必要はなく、スマートコントラクト自体で実現できます。
- この実装では、ロッカーと承認者の権利を分離することを提案しています。トークンは承認を得てロックでき、承認者はトークンのロック解除と引き出しができます(レンタル、レンディング、BNPLなどのオportunityを開く)。一方で、トークンの取り消し権限がなくてもロック解除できる(アカウントバウンドNFTなどのオportunityを開く)ようになっています。
- 私たちの提案では、`transferAndLock`機能を実装しており、これを使ってトークンを転送、ロック、必要に応じて承認することができます。これにより、転送後の取り消しの可能性が生まれます。

[ERC-721](./eip-721.md)スタンダードを拡張することで、提案されたスタンダードは、基礎となるNFTアセットの安全で便利な管理を可能にします。ステーキング、レンディング、レンタルなどの一般的なNFTFiユースケースをネイティブにサポートしています。この提案されたスタンダードにより、NFTオーナーのNFTFiプロジェクトへの参加が促進され、NFTエコシステム全体の活性化につながると期待しています。

## 仕様

この文書における「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」のキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとします。

### 概要

[ERC-721](./eip-721.md)準拠のコントラクトは、トークンの現在のオーナーアドレスでのロックとロック解除の標準的な方法を提供するために、このEIPを実装することができます。

トークンのオーナーは、`lock(uint256 tokenId, address _locker)`関数を使ってトークンをロックし、`_locker`アドレスを`ロッカー`として設定できます。トークンのオーナーまたは承認されたアドレスは、`lock(uint256 tokenId)`関数を使ってトークンをロックできます。この場合、`ロッカー`は`msg.sender`に設定されます。トークンは、`ロッカー`によって`unlock`関数を使ってロック解除できます。`unlock`関数は、`ロッカー`マッピングを削除し、`address(0)`にデフォルト設定する必要があります。

トークンが`ロック`されている場合、`lockerOf`関数は`ロッカー`アドレスを返す必要があり、そのアドレスがトークンをロック解除できます。トークンが`ロック`されていない場合、`lockerOf`関数は`address(0)`を返す必要があります。

`lock`関数は、トークンがすでに`ロック`されている場合、エラーを発生させる必要があります。`unlock`関数は、トークンが`ロック`されていない場合、エラーを発生させる必要があります。ERC-721の`approve`関数は、トークンが`ロック`されている場合、エラーを発生させる必要があります。トークンの所有権を移転するERC-721の関数は、`msg.sender`が`承認`され、かつ`ロッカー`でもある場合を除き、トークンが`ロック`されている場合、エラーを発生させる必要があります。ERC-721のトークン転送関数の呼び出し後、`ロッカー`と`承認`の値は消去される必要があります。

トークンは、`transferAndLock`関数を使って転送し、同時にロックし、`ロッカー`に承認を与えることができます。トークンの転送と後の取り消しが必要なユースケースで使うことをお勧めします。

### インターフェース

```
// SPDX-License-Identifier: CC0-1.0

pragma solidity >=0.7.0 <0.9.0;

/// @title Lockable Extension for ERC721
/// @dev Interface for the Lockable extension
/// @author StreamNFT 

interface IERC7066{

    /**
     * @dev Emitted when tokenId is locked
     */
    event Lock (uint256 indexed tokenId, address _locker);

    /**
     * @dev Emitted when tokenId is unlocked
     */
    event Unlock (uint256 indexed tokenId);

    /**
     * @dev Lock the tokenId if msg.sender is owner or approved and set locker to msg.sender
     */
    function lock(uint256 tokenId) external;

    /**
     * @dev Lock the tokenId if msg.sender is owner and set locker to _locker
     */
    function lock(uint256 tokenId, address _locker) external;

    /**
     * @dev Unlocks the tokenId if msg.sender is locker
     */
    function unlock(uint256 tokenId) external;

    /**
     * @dev Tranfer and lock the token if the msg.sender is owner or approved. 
     *      Lock the token and set locker to caller
     *      Optionally approve caller if bool setApprove flag is true
     */
    function transferAndLock(uint256 tokenId, address from, address to, bool setApprove) external;

    /**
     * @dev Returns the wallet, that is stated as unlocking wallet for the tokenId.
     *      If address(0) returned, that means token is not locked. Any other result means token is locked.
     */
    function lockerOf(uint256 tokenId) external view returns (address);
}
```

## 根拠

この提案では、トークンが`ロック解除`されたときに、`locker[tokenId]`を`address(0)`に設定します。これは、マッピングの`locker[tokenId]`を削除することで、スペースを解放するためです。また、この前提は、内部関数呼び出しの際に、トークンが`ロック`されているか`ロック解除`されているかを検証するのに役立ちます。

この提案では、`transferAndLock(uint256 tokenId, address from, address to, bool setApprove)`を公開しています。これを使って、トークンを転送し、受取人のアドレスでロックできます。さらに、`bool setApprove`入力を受け付けており、これが`true`の場合、`ロッカー`に`承認`を与えます。これにより、`ロッカー`がトークンを取り消すことができます(取り消しの条件はコントラクトで定義し、`承認`をコントラクトに提供できます)。これにより、受取人に条件付きの所有権を与えつつ、`転送`する権限は与えないことができます。

## 下位互換性

このスタンダードは、[ERC-721](./eip-721.md)スタンダードと互換性があります。

既存の[ERC-721](./eip-721.md)アップグレード可能なコントラクトは、このスタンダードにアップグレードすることで、ロック機能を自然に有効化し、基礎となる流動性機能を活用できるようになります。

## テストケース

テストケースは[こちら](../assets/eip-7066/test/test.js)にあります。

## 参考実装

参考インターフェースは[こちら](../assets/eip-7066/IERC7066.sol)にあります。

参考実装は[こ
ちら](../assets/eip-7066/ERC7066.sol)にあります。

## セキュリティ上の考慮事項

[ERC-721](./eip-721.md)を管理するコントラクトの実装に直接関連するセキュリティ上の考慮事項はありません。

### ロック可能なトークンを扱うコントラクトに対する考慮事項

- トークンが`ロック`されると、さらに`承認`や`転送`することはできません。
- トークンが`ロック`されており、呼び出し元が`ロッカー`かつ`承認`されている場合、呼び出し元はトークンを転送できます。
- アクセスできないアカウントや検証されていないコントラクトアドレスを`ロッカー`として持つ`ロック`されたトークンは、永久にロックされる可能性があります。
- ロック可能なトークンに関してはMEVの考慮事項はありません。承認された当事者のみがロックとロック解除を行えるためです。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)により放棄されています。