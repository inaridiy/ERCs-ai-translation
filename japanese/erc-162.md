---
original: f284f5535b3b776fbe294d60523af179e7805333550d79a2c226d58b8bd6cbc1
---

---
eip: 162
title: 初期 ENS ハッシュ登録システム
author: Maurelian, Nick Johnson <nick@ethereum.org>, Alex Van de Sande <avsa@ethereum.org>
status: 最終版
type: 標準化トラック
category: ERC
created: 2016-10-25
---

## 目次
- 概要
- 動機
- 仕様
  - 初期の制限
  - ハッシュ登録の名称フォーマット
  - 名称のオークション
  - 証書
  - デプロイメントとアップグレードプロセス
  - 登録システムのインターフェース
- 根拠
  - 最初から永続的な登録システムを決めないこと
  - 7文字以上の有効な名称
  - `.eth` TLDのみの制限
  - イーサーを担保として保持すること
- 先行研究

<!-- /MarkdownTOC -->

## 概要

このERCは、Ethereum Name Service (ENS)における名称割り当ての管理を行う登録システムの実装について説明しています。このシステムは2017年5月4日にメインイーサリアムネットワークにデプロイされました。対応するソースコードは[こちら](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)にあります。

詳細については[EIP-137](./eip-137.md)を参照してください。

> 登録システムはユーザーにドメイン名を割り当てる責任を負い、ENSレジストリの更新を行う唯一のエンティティです。登録システムはコントラクトや外部所有アカウントである可能性がありますが、少なくともルートやトップレベルの登録システムはコントラクトで実装されることが期待されています。
>
> \- EIP 137

EIP 137で説明されているENSの成功には、適切に設計され管理された登録システムが不可欠ですが、これはENSプロトコルの中核ではないため、別の文書で説明されています。

新しい名前空間の有用性と採用を最大化するためには、投機や「ドメイン名の囲い込み」を抑制する必要がありますが、その最適なアプローチは明確ではありません。そのため、単純なアプローチを採用する「初期」登録システムが提案されています。初期の期間中は、利用可能な名前空間が`.eth`トップレベルドメインに大幅に制限され、7文字未満のサブドメインは許可されません。この仕様は、議論を促進するために、@alexvandesande と @arachnid の[ハッシュ登録システムの実装](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)を主に説明しています。

初期登録システムを永続的な登録システムに置き換えることを意図しています。永続的な登録システムでは、利用可能な名前空間を拡大し、初期登録システムの運用実績から得られた教訓を取り入れる予定です。このアップグレードは、初期デプロイから約2年以内に行われる予定です。

## 動機

ENSの採用と初期登録システムの適切な管理を最適化するには、以下の要因を考慮する必要があります。

**アップグレード可能性:** 初期登録システムは安全にアップグレード可能でなければならず、その運用中に得られた知見を活用して、改善された永続的な登録システムに置き換えることができるようにする必要があります。

**効果的な割り当て:** 新しく公開された名前空間では、多くの潜在的に価値のある名称が購入されるものの使用されずに、転売の目的で保持されるという「土地の奪い合い」の状況が発生することがあります。これにより、最も有用な名称の利用可能性が減少し、結果としてエンドユーザーにとってのネームサービスの有用性が低下します。

効果的な割り当てを達成するには、紛争解決や他の形の管理のための人的介入が必要になる可能性があります。初期登録システムは、最も効果的な割り当てを目指すのではなく、長期的な誤割当ての費用を抑えることを目的とすべきです。

**セキュリティ:** 登録システムはイーサを保持する残高を持ちますが、明示的な上限はありません。そのため、セキュアに設計される必要があります。

**単純性:** ENS仕様自体は関心事の分離を強調しており、最も重要な要素であるレジストリを可能な限り単純に保つことを目指しています。同様に、暫定的な登録システムも、その他の設計目標を満たしつつ、可能な限り単純であるべきです。

**採用:** 成功した標準は、ネットワーク効果により、さらに成功するようになります。登録システムは、ENSの一般的な採用と、その管理下にある名前空間の採用を促進する戦略を検討する必要があります。

## 仕様

### 初期の制限

初期登録システムは約2年間のサービス提供が予定されており、その後、アップグレードされる予定です。この期間は、学習、観察、更新システムの設計を行うのに十分な時間です。

初期2年間は、利用可能な名前空間が`.eth` TLDに制限されます。

この制限は、ENSルートノードの所有者によって強制されます。ルートノードは、マルチシグコントラクトを使用して複数のパーティーによって管理される必要があります。

初期登録システムはまた、6文字以下の名称の登録を禁止します。

### ハッシュ登録の名称フォーマット

初期登録システムに提出される名称は、イーサリアムのsha3関数を使ってハッシュ化されなければなりません。提出されるハッシュは、EIP 137で定義されたnamehashではなく、登録するサブドメインラベルのハッシュであることに注意してください。

例えば、`abcdefg.eth`を登録するには、`sha3('abcdefg')`を提出する必要があり、`sha3(sha3(0, 'eth'), 'abcdefg')`ではありません。

### 名称のオークション

登録システムは、ヴィクリー式オークションを通じて利用可能な名称を割り当てます:

> ヴィクリー式オークションは、密封入札方式のオークションの一種です。入札者は他の参加者の入札額を知らされずに書面で入札します。最高入札者が落札者となりますが、落札価格は第二位の入札額となります。この種のオークションは...入札者に真の価値で入札するインセンティブを与えます。
>
> \- [ヴィクリー式オークション, Wikipedia](https://en.wikipedia.org/wiki/Vickrey_auction)

名称のオークションライフサイクルには5つの可能な状態、または「モード」があります。

1. **まだ利用可能ではない:** 大半の名称は当初利用できず、起動から8週間以内にいくつかずつ利用可能になります。
2. **オープン:** 名称の利用可能時期は、その sha3 ハッシュの最上位バイトによって決まります。`0x00`は即座に利用可能になり、`0xFF`は8週間後に利用可能になり、その他の名称の利用可能時期はこの間に分散されます。名称が利用可能になると、その名称でオークションを開始できます。
3. **オークション:** 名称のオークションが始まると、72時間の入札期間があります。入札者は、イーサを支払うとともに、`sha3(bytes32 hash, address owner, uint value, bytes32 salt)`のハッシュ値として密封入札を提出しなければなりません。入札者は、より多額のイーサを送ることで、実際の入札額を隠すことができます。
4. **公開:** 入札期間の後、48時間の公開期間が始まります。この期間中、入札者は密封入札の真の内容を公開しなければなりません。入札が公開されるにつれ、下表の「払い戻し比率」に従ってイーサが返金されます。入札が公開されない場合、その名称はオープン状態に戻ります。
5. **所有:** 公開期間が終了すると、落札者は最終的にオークションを確定するトランザクションを送信しなければなりません。これにより、ENSの`setSubnodeOwner`関数が呼び出され、名称のハッシュの所有者として落札者のアドレスが記録されます。

以下の表は、登録システムのオークションメカニズムを定義する重要なパラメーターを示しています。

#### 登録システムのパラメーター

|        名称        |                                            説明                                             |   値    |
|--------------------|----------------------------------------------------------------------------------------------------|----------|
| totalAuctionLength | オークション開始からの公開期間終了までの完全な期間。                                            | 5日     |
| revealPeriod       | 入札が許可されなくなり、入札を公開しなければならない期間。                                       | 48時間  |
| launchLength       | 全ての名称がオークションに利用可能になる期間。                                                  | 8週間   |
| minPrice           | 名称の所有権と引き換えに必要な最小のイーサ量。                                                   | 0.01イーサ |

### 証書

初期登録システムは自身で残高を保持しません。登録システムに送信されたすべてのイーサは、別の`Deed`コントラクトで保持されます。密封入札が提出されると、最初に証書コントラクトが作成され、資金が供給されます。オークションが完了し、ハッシュが登録されると、勝者の入札の証書が名称の所有権と引き換えに保持されます。負けた入札は払い戻されます。

所有されている名称の証書は、所有者によって別のアカウントに転送できるため、名称の所有権と管理権が移転します。

登録から1年後、名称の所有者は所有権を放棄し、証書の価値を返金することができます。

勝者以外の入札の証書は、様々な方法で閉鎖できます。その際、保持されていたイーサは入札者に返金されるか、焼却されるか、登録システムの運営に貢献した者に送金されます。

以下の表は、証書コントラクトの残高がどの割合で返金されるかを示しています。残りの残高は焼却されます。

#### 払い戻しのスケジュール

| 証書の閉鎖理由 | 払い戻し受取人 | 払い戻し割合 |
| --- | --- | --- |
| 有効な負けの入札が公開された。 | 入札者 | 99.5% |
| オークション期間後に提出された入札が公開された。 | 入札者 | 99.5% |
| 所有済みの名称に対する有効な入札が公開された。<sup>1</sup> | 入札者 | 0.5% |
| 期限切れの密封入札がキャンセルされた。<sup>2</sup> | キャンセラー | 0.5% |
| 登録されたハッシュが無効と報告された。<sup>3</sup> | 報告者 | 50% |
| 登録されたハッシュが無効と報告された。<sup>3</sup> | 所有者 | 50% |

##### 注記:

1. これにより、すべての入札が期限内に公開されるよう奨励されます。入札を遅れて公開できる場合、現在の最高入札者に対する恐喝攻撃が可能になります。
2. 2週間5日以上経過しても密封されたままの入札は、誰でもキャンセルして小額の報酬を得ることができます。
3. 名称はオークションと登録の前にハッシュ化されるため、初期登録システムは独自に文字数制限を施行できません。そのため、無効な名称を報告した者に報酬が提供されます。

### デプロイメントとアップグレードプロセス

初期登録システムはENSのアドレスをコンストラクタで要求するため、ENSの後にデプロイされる必要があります。その後、ENSのルートノードを所有するマルチシグアカウントが、初期登録システムのアドレスを`.eth`ノードの所有者として設定する必要があります。

初期登録システムは、デプロイから約2年後に永続的な登録システムに置き換えられる予定です。アップグレードには以下のプロセスを使用する必要があります:
1. 永続的な登録システムコントラクトがデプロイされます。
2. ENSのルートノードを所有するマルチシグアカウントが、`.eth`ノードの所有権を永続的な登録システムに割り当てます。
3. 初期登録システムのハッシュの所有者は、永続的な登録システムに自身の証書を登録する責任を負います。以下の2つのオプションが検討されています:
   1. 所有権を維持したり、名称解決サービスを継続するには、所有者が期限までに
1. 所有権を維持したり、名称解決サービスを継続するには、所有者が期限までに所有権を移転する必要がある。
   2. 永続的な登録システムが、エントリーがない場合に初期登録システムから所有権を照会できるようにする。

### 計画的な非活性化

初期登録システムへの依存を制限するため、新しいオークションは4年後に停止し、8年後にはすべての証書の残高が取り出し不可能になります。

### 登録システムのインターフェース

`function state(bytes32 _hash) constant returns (Mode)`
- ステートマシンを実装し、名称の現在の状態を返します。

`function entries(bytes32 _hash) constant returns (Mode, address, uint, uint, uint)`
- 登録された名称に関する以下の情報を返します:
  * 状態
  * 証書アドレス
  * 登録日
  * 証書の残高
  * オークションの最高入札額

`function getAllowedTime(bytes32 _hash) constant returns (uint timestamp)`
- ハッシュが初期の`まだ利用可能ではない`状態から抜け出す時刻を返します。

`function isAllowed(bytes32 _hash, uint _timestamp) constant returns (bool allowed)`
- ハッシュと時刻を受け取り、初期の`まだ利用可能ではない`状態を過ぎているかどうかを返します。

`function startAuction(bytes32 _hash);`
- ハッシュの状態をオープンからオークションに移行させます。状態がオープンでない場合は例外をスローします。

`function startAuctions(bytes32[] _hashes);`
- 複数のハッシュでオークションを開始します。これにより、実際に入札したいのは1つだけであっても、ダミーのハッシュ入札を行うことで、ブラインド入札を行う攻撃者のコストを引き上げることができます。入札されていないダミーのオークションは1週間後に閉鎖されます。

`function shaBid(bytes32 hash, address owner, uint value, bytes32 salt) constant returns (bytes32 sealedBid);`
- 入札のパラメーターを受け取り、オークションへの入札に必要な密封入札ハッシュ値を返します。これにより、入札の内容が隠蔽されます。

`function newBid(bytes32 sealedBid);`
- 入札は、密封入札ハッシュと入札額のイーサを送信することで行われます。ハッシュには、入札名称ハッシュ、入札額、ランダムなsaltなどの情報が含まれています。入札は特定のオークションに紐付けられるまで、公開されません。実際の入札額よりも多額のイーサを送ることで、入札額を偽装できます。これに続いて48時間の公開期間があります。この期間を過ぎて公開された入札は焼却され、イーサは回収できません。オークションであるため、一般的な名称やよく知られた単語などには、複数の入札者が押し上げ合うことが期待されます。

`function startAuctionsAndBid(bytes32[] hashes, bytes32 sealedBid)`
- `startAuctions`と`newBid`を1つのトランザクションで呼び出すためのユーティリティ関数です。

`function unsealBid(bytes32 _hash, address _owner, uint _value, bytes32 _salt);`
- 入札期間が終了すると、入札の内容を公開する期間が始まります。登録システムは、上記の`shaBid()`関数を使ってこれらのプロパティをハッシュし、事前に存在した密封入札と一致することを確認します。新しい最高入札が明らかになった場合、古い最高入札は入札者に返金されます。

`function cancelBid(bytes32 seal);`
- 上記の払い戻しスケジュールの注記に説明されている規則に従い、公開されていない入札をキャンセルします。

`function finalizeAuction(bytes32 _hash);`

登録期限が過ぎた後、この関数を呼び出してオークションを確定すると、ENSの`setSubnodeOwner()`関数が呼び出され、ENSレコードが更新され、落札者が当該ノードの所有者となります。

`function transfer(bytes32 _hash, address newOwner);`
- 提出されたハッシュに対応するENSノードの所有者を新しい所有者に更新します。この関数は、現在の所有者からのみ呼び出し可能でなければなりません。

`function releaseDeed(bytes32 _hash);`
- 一定期間経過後、所有者はプロパティを解放し、イーサを取り戻すことができます。

`function invalidateName(string unhashedName);`
- 登録はハッシュ化された名称で行われるため、登録システム自体では名称の検証ができません。この関数を使って、6文字以下の名称として登録されているものを報告できます。報告者には証書の価値の10%が報酬として支払われます。我々は意図的に簡略化された登録システムを制限することで、数年後の再構築を促します。

`function eraseNode(bytes32[] labels)`
- 登録システムが所有していないサブドメインのオーナーとリゾルバーのレコードを誰でも削除できるようにします。例えば、`.eth`を所有する登録システムで`foo.bar.eth`を0にするには、`[sha3('foo'), sha3('bar')]`の配列を渡します。

`function transferRegistrars(bytes32 _hash) onlyOwner(_hash);`
- 永続的な登録システムへのアップグレード時に使用されます。この登録システムがもはやENSのルートノードの所有者ではない場合、この関数は証書を現在の所有者(新しい登録システムであるはず)に転送します。この登録システムがまだルートノードを所有している場合、この関数はエラーをスローします。

## 根拠

### 一時的な登録システムから始める

名称割り当ての潜在的な問題をすべて予想し設計することは困難です。このアプローチでは完璧を目指すのではなく、トレーニングホイールをつけた状態で観察し学習し、利用可能な名前空間を拡大する前に改善を行うことを選択しています。

### 7文字以上の有効な名称

最も短く、多くの場合最も価値のある、ドメイン名を改善された登録システムのために保持することで、必要に応じて紛争解決プロセスを実装する機会が得られます。

### 名称の遅延リリース

より遅いリリースにより、起動後に発生する可能性のある問題を特定し対処するための余分な時間が得られます。

### `.eth` TLDのみの制限

単一のTLDを選択することで、1つの名前空間に焦点を当てることにより、ネットワーク効果を最大化することができます。

3文字のTLDは、インターネットのドメイン名で一般的に使用されているパターンです。この馴染みの深さにより、ENSが既存のDNSシステムに統合されたり、[特殊用途ドメイン名](https://www.iana.org/assignments/special-use-domain-names/special-use-domain-names.xhtml#special-use-domain)として予約される可能性が大きく高まります。最近の先例は[`.onion`ドメインの予約](https://tools.ietf.org/html/rfc7686)です。

### イーサを担保として保持すること

これは、所有者に定期的な支払いを要求するという一般的なモデルよりも単純です。また、初期登録システムを収支相償のサービスにすることができます。

## 先行研究

この文書は、いくつかの情報源から多くを借用しています:
- [EIP-137](./eip-137.md)は、レジストリコントラクト(ENS.sol)および関連するリゾルバーコントラクトの初期実装を概説しています。
- [ERC-26](https://github.com/ethereum/EIPs/issues/26)は、コントラクトレイヤーでネームサービスを提案した最初のERCでした。
- @alexvandesande の現在の[HashRegistrar](https://github.com/ethereum/ens/blob/mainnet/contracts/HashRegistrarSimplified.sol)の実装

### 編集履歴:
- 2016-10-26 抽象にAlexの設計へのリンクを追加
- 2016-11-01 「計画的な非活性化」をh3に変更
- 2017-03-13 入札と公開期間のタイムラインを更新

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。