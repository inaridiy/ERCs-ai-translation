---
original: cb6816db2ec7b836217f94178d4566320e5a56296bf8ed683d2511faac5efcea
---

---
eip: 7272
title: Ethereum Access Token
description: オフチェーンサービスからの関数呼び出しを承認するためのプロトコル
author: Chris Chung (@0xpApaSmURf), Raphael Roullet (@ra-phael)
discussions-to: https://ethereum-magicians.org/t/eip-7272-ethereum-access-token/14945
status: Draft
type: Standards Track
category: ERC
created: 2023-07-03
requires: 712
---

## 概要

Ethereum Access Token (EAT)は、[EIP-712](./eip-712.md)に準拠した署名付きメッセージで、オフチェーンサービスがイーサリアムアカウントに特定のオンチェーンリソースへのアクセスを許可するために使用されます。EATはJSON Web Tokens (JWTs)と似ていますが、短期的な承認を行うためのものです。ただし、Ethereum Access Tokensは、スマートコントラクトの関数呼び出しを承認するために特別に設計されています。

## 動機

他の提案では認証や承認を狭い範囲で扱っているのに対し、この仕様では開発者が最小限の変更で任意の関数にアクセス制御レイヤーを追加できるようになります。オフチェーンサービスが事前に承認を与えた場合にのみ、エンドユーザーが直接トランザクションを送信してオンチェーンリソースにアクセスできるようなユースケースに最適です。そのような例としては、オフチェーンの検証者が資格要件を評価(例えば検証可能な資格情報を確認)して、トークンのミントや特定のコンプライアンス状態を要求するスマートコントラクトとの対話を許可するようなものが考えられます。
したがって、この提案により、オフチェーンシステムはイーサリアムアカウントのコントローラーを任意の方法で認証した上で、そのアカウントに対する承認を付与することができます。

この仕様は、一貫したマシンリーダブルなメッセージフォーマットを提供することで、イーサリアムエコシステムの相互運用性を向上させることを目的としています。

EATsは、現在の標準的なアクセス制御メカニズム(ロールベースのアクセス修飾子やNFTの所有権チェックなど)では満たされない以下のようなアクセス制御要件に対応します:

- 必要なアクセスが短期的である
- 基準が柔軟/動的である: アクセス付与の要件を更新してもオンチェーンでの変更は不要
- Soulboundやその他のオンチェーントークンのセマンティクスが望ましくない場合。「オンチェーンレジストリ」を使ってアクセス権を付与すると、そのレジストリの所有者がオンチェーンの状態を常に最新に保つ必要があります。そうしないと、オンチェーンの状態が正しくない期間に誤ってアクセス権が付与される可能性があります。EATsの場合、ユーザーがアクセス権を要求する際に、発行者が確認と記録の更新を行うことができます。さらに、オンチェーンデータに完全に依存すると、多くの現在のチェーンが公開されているため、プライバシーの問題が生じる可能性があります。機密情報や個人を特定できる情報に基づいてアクセス権を付与する必要がある場合、それをオンチェーンに保存して参照するのは推奨されません。Ethereum Access Tokensは、PII をオンチェーンに漏らすことなく、代替手段を提供します。

## 仕様

この文書における「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」のキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとします。

### 概要

DeFiアプリケーションに統合された例のフローは以下の通りです:

1. ユーザーがDeFiのオフチェーンサービスと対話し、オフチェーンサービスが基準を満たしていることを確認する(例えば、ユーザーを認証したり、有効な資格情報を持っていることを確認する)
2. 承認が付与された場合、ユーザーにEATが発行される
3. ユーザーは指定された期間内に、EATを渡してゲートされたスマートコントラクト関数と対話する
4. EATがオンチェーンで検証される

![EATを使ったトランザクション承認フロー](../assets/eip-7272/EAT_transaction_auth_flow.png)

Ethereum Access Tokenは、発行時に特定のパラメーターに結び付けることで、きめ細かなアクセス制御を保証しなければなりません。その後、オンチェーンでのEAT検証により、以下が確認されます:

- 呼び出される関数が期待されたものであること
- 関数パラメーターが期待されたものであること
- 関数呼び出し元が期待されたものであること
- 関数が承認された期間内に呼び出されていること(つまり、EATが期限切れでないこと)
- 呼び出されるスマートコントラクトが期待されたものであること
- 承認が有効な発行者によって与えられたものであること(つまり、EATが期待された発行者によって署名されていること)

### Ethereum Access Tokenの構造

Ethereum Access Tokenは、署名と有効期限で構成されます。

```
{
 uint8 v,
 bytes32 r,
 bytes32 s,
 uint256 expiry
}
```

署名は、typed structured data hashing and signing standard (EIP-712)を使って取得されます。以下のEATペイロードに署名します:

```
struct AccessToken {
    uint256 expiry;
    FunctionCall functionCall;
}

struct FunctionCall {
    bytes4 functionSignature;
    address target;
    address caller;
    bytes parameters;
}
```

- **expiry**: Unix タイムスタンプ、`block.timestamp`より前であることが期待される

`FunctionCall`パラメーターは以下のようになります:

- **functionSignature**: 呼び出される関数の識別子、`msg.sig`と一致することが期待される
- **target**: 呼び出されるターゲットコントラクトのアドレス
- **caller**: 現在の呼び出し元のアドレス、`msg.sender`と一致することが期待される
- **parameters**: `calldata`から`v`、`r`、`s`、`expiry`を除いたもの

### EAT検証

オンチェーンでは、参照実装では2つのコントラクトを使用します: 一部の関数にアクセス制御を設けるための`AccessTokenConsumer`と、EATを検証する`AccessTokenVerifier`です。

`AccessTokenConsumer`コントラクトは、EATの整合性を検証するために`AccessTokenVerifier`を呼び出します。

`AccessTokenVerifier`の`verify()`関数は、署名と`AccessToken`を入力として受け取り、トークンが期限切れでないことを確認し、署名から署名者を復元し、署名者が有効な発行者であることを検証します。

EATの検証方法の例については、[参照実装](../assets/eip-7272/AccessTokenVerifier.sol)を参照してください。

## 根拠

- 使い捨て。参照実装では、EATの再利用を保証していますが、他の実装では異なるアプローチを採用する可能性があります。

- EIP-712の使用。EIP-712に準拠することで、EATsは既存のイーサリアムインフラストラクチャと相互運用可能になり、開発者は最小限の変更でアクセス制御を作成できます。また、発行されたEATsが特定のチェーンにバインドされることも保証されます。

- ゼロ知識証明。ZKPsを使用すると複雑性が増加するコストがかかります。EATsは単なる署名付きメッセージにすぎず、理解が容易です。`ecrecover`はイーサリアムスマートコントラクトで標準的に利用可能ですが、ZKPsにはさまざまな形式があり、相互運用性が低下します。

## 下位互換性

`receive`および`fallback`関数を除き、任意の関数をEATでゲートできます。

## 参考実装

EATシステムのオンチェーンでの参考実装は以下の通りです:

- [IAccessTokenVerifier.sol](../assets/eip-7272/IAccessTokenVerifier.sol)
- [AccessTokenVerifier.sol](../assets/eip-7272/AccessTokenVerifier.sol)
- [AccessTokenConsumer.sol](../assets/eip-7272/AccessTokenConsumer.sol)

## セキュリティ上の考慮事項

Ethereum Access Token (EAT)提案のセキュリティは、いくつかの要因に依存します:

### リプレイ攻撃

実装では、EATが一度消費されると再利用できないようにする必要があります。これは、`_consumeAccessToken`関数でEATを消費済みとしてマークすることで実現できます。

### オフチェーンの発行

EATを発行するオフチェーンサービスのセキュリティが重要です。このサービスが侵害されると、悪意のあるアクターがアクセス権を持つEATを不正に取得し、オンチェーンリソースにアクセスできてしまう可能性があります。

### 有効期限の考慮事項

EATの有効期限は、利便性とセキュリティのバランスを取るように慎重に設定する必要があります。有効期限が長すぎると、EATの悪用リスクが高まります。一方で短すぎると、アプリケーションの利便性が損なわれる可能性があります。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)により放棄されています。