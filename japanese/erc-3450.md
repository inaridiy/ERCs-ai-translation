---
original: bbda34ec506a15fcd1d317c024e7fc7b3dffa16d8ed11d91157105969da2386d
---

---
eip: 3450
title: BIP-39 ニーモニックのための標準化されたシャミアの秘密分散方式
author: Daniel Streit (@danielstreit)
discussions-to: https://ethereum-magicians.org/t/erc-3450-standard-for-applying-shamirs-to-bip-39-mnemonics/5844
status: 停滞
type: Standards Track
category: ERC
created: 2021-03-29
---

## 簡単な要約

BIP-39 ニーモニックにシャミアの秘密分散方式を適用するための標準化されたアルゴリズム。

## 概要

BIP-39 ニーモニックを _N_ 個の BIP-39 ニーモニック（シェア）に分割し、_T_ 個のシェアがあれば元のニーモニックを復元できるが、_T_ 未満のシェアでは元のニーモニックに関する情報が漏洩しない、という標準化されたアプローチ。

## 動機

テクニカルな知識の少ないユーザーでも鍵を安全に保管できるようにしたい。

現在多くのユーザーは、鍵の基となるエントロピーを保存するために BIP-39 ニーモニックを使用している。しかしこれらのニーモニックは単一障害点となっている。紛失すれば、鍵によってロックされた資産にアクセスできなくなる可能性がある。盗まれれば、悪意のある者に資産を奪われる可能性がある。

シャミアの秘密分散方式はこの問題に直接取り組む。秘密を「シェア」に分割し、最小限のしきい値のシェアがあれば秘密を復元できるが、それ未満では秘密に関する情報は一切漏洩しない。

シャミアの秘密分散方式の懸念点の1つは、標準的な実装がないことである。これにより、ツールの変更に伴って復元が危険にさらされる可能性がある。

ここでは、ユーザーが簡単にニーモニックのシェアを作成、元のニーモニックを破棄、シェアを適切に保管、そして後に自信を持って元のニーモニックを復元できるよう、BIP-39 ニーモニックに特化したシャミアの秘密分散方式の標準的な実装を提案する。

## 仕様

### シャミアの秘密分散方式

シャミアの秘密分散方式は、秘密を _N_ 個の固有の部分に分割し、その中の _T_ 個以上が揃えば秘密を再構築できる暗号学的手法である。

まず、次数 _T_ - 1 の多項式 _f_ を構築する。次に、各シェアは多項式の曲線上の1点、すなわち整数 _x_ とその対応する _y_ 点 _f_(_x_) で表される。

_T_ 個以上のシェア（または点）があれば、多項式補間を使って元の多項式を復元できる。

初期の多項式を構築する際、秘密は _x_<sup>0</sup> の係数として格納され、他の係数はランダムに生成される。

### BIP-39 ニーモニック

BIP-39 は、エントロピーを単語のリストとして保存するための一般的な標準である。生の2進数や16進数表現よりも人間にとって扱いやすい。

BIP-39 ニーモニックには2つのデータがエンコードされている: 元のエントロピーとそのチェックサム。チェックサムにより、ユーザーが正しくニーモニックを入力したことを検証できる。

#### ニーモニックの生成

ニーモニックはエントロピーを32ビットの倍数でエンコードしなければならない。エントロピーが多いほどセキュリティは向上するが、文章の長さも増える。初期のエントロピー長を ENT と呼ぶ。ENT は128-256ビットの範囲内である。

まず、ENT ビットの初期エントロピーを生成する。チェックサムは、その SHA256 ハッシュの最初の `ENT / 32` ビットを取ることで生成される。このチェックサムが初期エントロピーの末尾に追加される。次に、これらの連結ビットを11ビットずつのグループに分割し、各グループは0-2047の数値をエンコードし、単語リストのインデックスとなる。最後に、これらの数値を単語に変換し、連結した単語をニーモニックの文章とする。

初期エントロピー長 (ENT)、チェックサム長 (CS)、生成されるニーモニックの単語数 (MS) の関係は以下の表の通りである。

```
CS = ENT / 32
MS = (ENT + CS) / 11

|  ENT  | CS | ENT+CS |  MS  |
+-------+----+--------+------+
|  128  |  4 |   132  |  12  |
|  160  |  5 |   165  |  15  |
|  192  |  6 |   198  |  18  |
|  224  |  7 |   231  |  21  |
|  256  |  8 |   264  |  24  |
```

#### エントロピーの復元

初期エントロピーは、上記のプロセスを逆に行うことで復元できる。ニーモニックをビットに変換し、各単語をリスト内のインデックスを表す11ビットに変換する。エントロピー部分の長さは、ニーモニックの長さに応じて表に従って定まる。

#### 単語リスト

この仕様では BIP-39 英語単語リストのみをサポートするが、将来的に拡張される可能性がある。

[単語リスト](../assets/eip-3450/wordlist.txt)を参照。

### BIP-39 ニーモニックへのシャミアの方式の適用

シェアが有効な BIP-39 ニーモニックであることを確保するため、以下の手順を踏む:

1. 対象の BIP-39 ニーモニックからその基となるエントロピーを復元する
2. エントロピーにシャミアの方式を適用する
3. 各シェアの _y_ 値を BIP-39 ニーモニックに変換する

エントロピーに変換してからシャミアの方式を適用することで、初期の秘密からチェックサムを除外できる。これにより、各シェアのチェックサムを新たに計算し、BIP-39 に準拠したニーモニックを生成できる。

エントロピーにシャミアの方式を適用する際は、エントロピーの各バイトに個別に適用し、GF(256) を基礎体とする。バイトは AES で使用されるリンダール不可約多項式 _x_<sup>8</sup> + _x_<sup>4</sup> + _x_<sup>3</sup> + _x_ + 1 を法として、GF(256) の要素として解釈される。

### シェアのフォーマット

シェアは、分割に使用された多項式の曲線上の1点を表す。2つのデータ要素から構成される:

- ID: シェアの _x_ 値
- BIP-39 ニーモニック: シェアの _y_ 値を表すニーモニック

### シェアの作成

入力: BIP-39 ニーモニック、シェア数 (_N_)、しきい値 (_T_)

出力: _N_ 個のシェア。各シェアにはID (_x_ | 0 &lt; _x_ &lt; 256) と入力ニーモニックと同じ長さの BIP-39 ニーモニックが含まれる

1. 以下の条件を確認する:
   - 1 < T <= N < 256
   - ニーモニックが [BIP-39](#generating-the-mnemonic) に準拠していること
2. [ニーモニックの基となるエントロピーを復元](#recovering-the-entropy)し、バイトベクトルとする
3. 以下の値を定義する:
   - _E_ をニーモニックのエントロピーのバイトベクトル表現とする
   - _n_ を _E_ の長さとする
   - _coeff<sub>1</sub>_, ... , _coeff<sub>T - 1</sub>_ をGF(256)<sup>_n_</sup>の要素であり、暗号鍵生成に適した乱数源から均一に生成されたバイトベクトルとする
4. 各シェアの多項式を評価する
   - 1 から _N_ までの各 _x_ について、多項式 _f(x)_ = _E_ + _coeff<sub>1</sub>x<sup>1</sup>_ + ... + _coeff<sub>T - 1</sub>x<sup>T - 1</sup>_ を評価し、_f(x)_ をシェアの値（バイトベクトル）とする
5. _f(x)_ をエントロピーとして使い、[ニーモニックを生成](#generating-the-mnemonic)する
6. 各シェアのIDとニーモニックを返す

### ニーモニックの復元

元のニーモニックを復元するには、与えられたシェア（多項式上の点）から多項式 _f_ を補間し、_f(0)_ を評価する。

#### 多項式補間

_m_ 個の点 (_x<sub>i</sub>_, _y<sub>i</sub>_), 1 &le; _i_ &le; _m_ が与えられ、_x<sub>i</sub>_ の値が互いに異なるとき、各点 _x<sub>i</sub>_ で値 _y<sub>i</sub>_ をとる唯一の多項式が存在する。この多項式の最小次数は以下のラグランジュ補間公式で得られる。

シャミアの秘密分散方式は共有ニーモニックのエントロピーの各バイトに個別に適用されるため、_y<sub>i</sub>_ はバイトベクトル _n_ 個の値 _y<sub>i</sub>_[_k_] = _f<sub>k</sub>_(_x<sub>i</sub>_), 1 &le; _k_ &le; _n_ として扱い、_f<sub>k</sub>_ は _k_ 番目の多項式インスタンスである。

#### Interpolate(_x_, {(_x<sub>i</sub>_, _y<sub>i</sub>_), 1 &le; _i_ &le; _m_})

入力: 目的のインデックス _x_、インデックス/値ベクトルのペアの集合 {(_x<sub>i</sub>_, _y_<sub>_i_</sub>), 1 &le; _i_ &le; _m_} &subseteq; GF(256) &times; GF(256)<sup>_n_</sup>

出力: 値ベクトル (_f_<sub>1</sub>(_x_), ... , _f<sub>n</sub>_(_x_))

![f_k(x) = \sum_{i=1}^m y_i[k] \prod_{\underset{j \neq i}{j=1}}^m \frac{x - x_j}{x_i - x_j}](../assets/eip-3450/lagrange.gif)

#### ニーモニックの復元

入力: _m_ 個のシェア

出力: 元のニーモニック

1. 各シェアのニーモニックから[基となるエントロピーを復元](#recovering-the-entropy)し、バイトベクトルとする
2. _E_ = Interpolate(0, [(_x<sub>1</sub>_, _y<sub>1</sub>_),...,(_x<sub>m</sub>_, _y<sub>m</sub>_)]) を計算する。ここで _x_ はシェアのID、_y_ はシェアのニーモニックのエントロピーのバイトベクトルである
3. _E_ をエントロピーとして使い、[ニーモニックを生成](#generating-the-mnemonic)し、それを返す

## 根拠

### 体の選択

GF(256) を選択した理由は、どの言語でも簡単に実装できる体算術であり、AES 暗号で使用されているため多くの実装が既に存在しているためである。GF(256) を使うには、ニーモニックをバイトベクトルのエントロピーに変換する必要があるが、これも多くの言語で簡単に実装できる。

GF(2048) も検討した。GF(2048) を使えば、ニーモニックの単語インデックスを値として直接シャミアの方式を適用できる。しかし、その場合シェアは有効な BIP-39 ニーモニックにはならず、エントロピーのチェックサムが正しくない。これを回避するには複雑さが増してしまう。

もう1つのオプションは、エントロピーのビット数に等しい GF(2<sup>_n_</sup>) を使うことだった。この場合もニーモニックをエントロピーに変換する必要があるが、エントロピー全体にシャミアの方式を適用できる。ただし、ニーモニックの強度に応じて異なる体とその不可約多項式を使う必要があり、さらに非常に大きな数値を扱う必要があるため、一部の言語では扱いづらい可能性がある。

### 有効なシェアのニー
モニックとシェアのID

仕様では、シェアにIDに加えてBIP-39ニーモニックが含まれている。

別のオプションとしては、IDをニーモニックに埋め込むことで保管が簡単になる可能性がある。

1つの可能性は、チェックサムの代わりにIDを保存することだ。この方法の欠点は、「チェックサム」部分がエントロピーと一致しないため、シェアがBIP-39の有効なニーモニックにはならないことである。有効なBIP-39ニーモニックであるシェアは有用である。なぜなら、他のニーモニックと区別がつかないからだ。ユーザーはIDを様々な方法で隠して保管できる。

### 復元時の検証

元のニーモニックを復元する際に検証メカニズムを含めないことにした。これにより、攻撃者に _T_ + 1 個のシェアが必要であることを示唆せずに済む。

復元時の検証を行うには、ランダムな係数の1つを元のニーモニックのチェックサムに置き換えることができる。その後、元のニーモニックと多項式を復元する際に、チェックサムの係数が正しいことを検証できる。

## テストケース

近日公開予定。

すべての実装は以下を行えなければならない:

- 与えられた `mnemonic`、`numShares`、`threshold` でシェアを分割し、復元する。
- 与えられた `knownShares` から `mnemonic` を復元する。

## セキュリティ上の考慮事項

仕様のシェアにはIDに加えてBIP-39ニーモニックが含まれている。これには2つのセキュリティ上の懸念がある:

ユーザーは、元のニーモニックを復元するためにこのIDを必ず保持しなければならない。IDを紛失したり、シェアのニーモニックから分離してしまうと、元のニーモニックを復元できない可能性がある（シェアの数としきい値が既知であれば、ブルートフォース攻撃で復元できるかもしれない）。

この追加データにより、攻撃者に他の鍵の存在とその保管方式が示唆される可能性がある。したがって、IDは用途が分からないように保管する必要がある。

## 著作権

著作権およびそれに関連する権利は [CC0](../LICENSE.md) により放棄されています。