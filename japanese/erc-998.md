---
original: 9d447561b5840e95423f024d9945285cef345e59187b659bec78ab557556bf2d
---

---
eip: 998
title: 合成可能な非代替性トークン
description: ERC-721を拡張して、他のERC-721およびERC-20トークンを所有できるようにする。
author: Matt Lockyer <mattdlockyer@gmail.com>、Nick Mudge <nick@perfectabstractions.com>、Jordan Schalm <jordan.schalm@gmail.com>、sebastian echeverry <sebastian.echeverry@robotouniverse.com>、Zainan Victor Zhou (@xinbenlv)
discussions-to: https://ethereum-magicians.org/t/erc-998-composable-non-fungible-tokens-cnfts/387
status: ドラフト
type: Standards Track
category: ERC
created: 2018-07-07
requires: 20, 165, 721
---

## 概要

[ERC-721標準](./eip-721.md)の拡張機能で、ERC-721トークンがERC-721トークンとERC-20トークンを所有できるようになります。

[ERC-20](./eip-20.md)および`ERC-223 https://github.com/ethereum/EIPs/issues/223`標準の拡張機能で、ERC-20および`ERC-223`トークンがERC-721トークンによって所有されるようになります。

この仕様には4種類の合成可能なトークンが含まれています:

1. [`ERC998ERC721` トップダウン型の合成可能トークンで、ERC-721トークンを受け取り、保持し、転送する](#erc-721-トップダウン型の合成可能)
2. [`ERC998ERC20` トップダウン型の合成可能トークンで、ERC-20トークンを受け取り、保持し、転送する](#erc-20-トップダウン型の合成可能)
3. [`ERC998ERC721` ボトムアップ型の合成可能トークンで、他のERC-721トークンに自身を付加する](#erc-721-ボトムアップ型の合成可能)
4. [`ERC998ERC20` ボトムアップ型の合成可能トークンで、ERC-721トークンに自身を付加する](#erc-20-ボトムアップ型の合成可能)

これらは以下のように対応しています:

1. `ERC998ERC721`トップダウン型の合成可能トークンは、他のERC-721トークンを所有する機能を持つERC-721トークンです。
2. `ERC998ERC20`トップダウン型の合成可能トークンは、ERC-20トークンを所有する機能を持つERC-721トークンです。
3. `ERC998ERC721`ボトムアップ型の合成可能トークンは、他のERC-721トークンに所有される機能を持つERC-721トークンです。
4. `ERC998ERC20`ボトムアップ型の合成可能トークンは、ERC-721トークンに所有される機能を持つERC-20トークンです。

トップダウン型の合成可能コントラクトは、各トークンの子トークンを保存し、管理します。

ボトムアップ型の合成可能コントラクトは、各トークンの親トークンを保存し、管理します。

合成可能トークンを使うと、ERC-721およびERC-20トークンを所有関係で連結したリストやツリー構造を作ることができます。そのような構造の最上位にある所有者アドレスが、全体の所有者となります。最上位の所有者を変更すれば、全体の構造を一度の取引で移転できます。

トップダウン型とボトムアップ型の合成可能には、それぞれ長所短所があり、[Rational section](#rationale)で説明しています。1つのトークンが複数の種類の合成可能トークンになることもできます。

非代替性トークンがこのEIPに準拠し、合成可能であるためには、以下のインターフェースのいずれかを実装する必要があります:

* `ERC998ERC721TopDown`
* `ERC998ERC20TopDown`
* `ERC998ERC721BottomUp`
* `ERC998ERC20BottomUp`

## 仕様

### ERC-721

`ERC998ERC721`トップダウン型、`ERC998ERC20`トップダウン型、および`ERC998ERC721`ボトムアップ型の合成可能コントラクトは、[ERC-721インターフェース](./eip-721.md)を実装しなければなりません。

### ERC-20

`ERC998ERC20`ボトムアップ型の合成可能コントラクトは、[ERC-20インターフェース](./eip-20.md)を実装しなければなりません。

### [ERC-165](./eip-165.md)

[ERC-165標準](./eip-165.md)は、使用される[ERC-998](./eip-998.md)インターフェースに適用されなければなりません。

### 認証

`ERC998ERC721`トップダウン型と`ERC998ERC721`ボトムアップ型の合成可能トークンの認証は同じ方法で行います。

`rootOwner`は、合成可能トークンとERC-721トークンの所有権ツリーの最上位にいる所有者アドレスを指します。

合成可能トークン内部の認証は、`rootOwner`を見つけ、それを`msg.sender`、`getApproved(tokenId)`の戻り値、`isApprovedForAll(rootOwner, msg.sender)`の戻り値と比較することで行います。一致すれば認証は成功し、一致しなければ認証は失敗してコントラクトがスローします。

以下は認証コードの例です:

```solidity
address rootOwner = address(rootOwnerOf(_tokenId));
require(rootOwner == msg.sender || 
  isApprovedForAll(rootOwner,msg.sender) ||
  getApproved(tokenId) == msg.sender);
```

ERC-721の`approve(address _approved, uint256 _tokenId)`および`getApproved(uint256 _tokenId)`関数は、`rootOwner`専用に実装されます。これにより、子の合成可能トークンで承認されていた場所を気にせずに、合成可能トークンのツリー全体を新しい`rootOwner`に移転できます。

以下は実装例です:

```solidity
function approve(address _approved, uint256 _tokenId) external {
  address rootOwner = address(rootOwnerOf(_tokenId));	
  require(rootOwner == msg.sender || isApprovedForAll(rootOwner,msg.sender));

  rootOwnerAndTokenIdToApprovedAddress[rootOwner][_tokenId] = _approved;
  emit Approval(rootOwner, _approved, _tokenId);
}

function getApproved(uint256 _tokenId) public view returns (address)  {
  address rootOwner = address(rootOwnerOf(_tokenId));
  return rootOwnerAndTokenIdToApprovedAddress[rootOwner][_tokenId];
}
```

### 走査

`rootOwnerOf(uint256 _tokenId)`または`rootOwnerOfChild(address _childContract, uint256 _childTokenId)`を呼び出すことで、合成可能トークンのルート所有者を取得できます。これらの関数は、トップダウン型とボトムアップ型の合成可能トークンが相互運用できるようにするために使用されます。

`ERC998ERC721`トップダウン型とボトムアップ型の合成可能トークンは相互運用可能です。トップダウン型の合成可能トークンがボトムアップ型の合成可能トークンを所有したり、トップダウン型の合成可能トークンがボトムアップ型のトークンを所有したりすることができます。どのような構成でも、`rootOwnerOf(uint256 _tokenID)`を呼び出せば、所有権ツリーの最上位にいる所有者アドレスが返されます。

`rootOwnerOf`の走査ロジックを正しく実装することが重要です。ロジックは、合成可能トークンがボトムアップ型かトップダウン型か、あるいはその両方かに関わらず同じです。
以下がそのロジックです:

```
rootOwnerOf(uint256 _tokenId)のロジック

トークンがボトムアップ型の合成可能トークンで、親トークンを持っている場合
    親トークンのrootOwnerOfを呼び出す
        呼び出しが成功した場合、返されたアドレスがrootOwnerである
        呼び出しが失敗した場合、親トークンのrootOwnerOfChildを呼び出す
            呼び出しが成功した場合、返されたアドレスがrootOwnerである
            呼び出しが失敗した場合、トークンの所有者アドレスがrootOwnerである
それ以外の場合、トークンのrootOwnerOfChildを呼び出す
    呼び出しが成功した場合、返されたアドレスがrootOwnerである
    呼び出しが失敗した場合、トークンの所有者アドレスがrootOwnerである
```

`rootOwnerOfChild`を呼び出すロジックは以下の通りです:

```solidity
// tokenIdのrootOwnerOfChildを呼び出すロジック
address tokenOwner = ownerOf(tokenId);
address childContract = address(this);
bytes32 rootOwner = ERC998ERC721(tokenOwner).rootOwnerOfChild(childContract, tokenId);
```

ただし、呼び出しが失敗したかどうかを確認し、`staticcall`オペコードを使ってステートを変更しないようにするため、実際の呼び出しはアセンブリで行う必要があります。

上記の認証と走査の機能を実装したトークン/コントラクトは「合成可能対応」です。

### 合成可能な転送関数のパラメータ形式

合成可能な転送関数のパラメータは、**from:to:what**の形式に従います。

例えば、`getChild(address _from, uint256 _tokenId, address _childContract, uint256 _childTokenId)`という合成可能な関数は、ERC-721トークンをトップダウン型の合成可能トークンに転送します。`_from`パラメータが**from**、`_tokenId`パラメータが**to**、`address _childContract, uint256 _childTokenId`パラメータが**what**に相当します。

別の例は`safeTransferChild(uint256 _fromTokenId, address _to, address _childContract, uint256 _childTokenId)`関数です。`_fromTokenId`が**from**、`_to`が**to**、`address _childContract, address _childTokenId`パラメータが**what**に相当します。

### transferFrom/safeTransferFrom関数はトークンが所有するトークンを転送しない

ボトムアップ型とトップダウン型の合成可能コントラクトでは、`transferFrom`および`safeTransferFrom`関数を直接呼び出して、トークンが所有するトークンを転送しようとした場合、スローしなければなりません。

その理由は、これらの関数では、転送するトークンを所有しているトークンを明示的に指定していないためです。[詳細はRational sectionを参照](#explicit-transfer-parameters)

`transferFrom/safeTransferFrom`関数は、アドレスが所有するトークンを転送するために使用されなければなりません。

### ERC-721トップダウン型の合成可能

ERC-721トップダウン型の合成可能トークンは、ERC-721トークンのコンテナとして機能します。

ERC-721トップダウン型の合成可能トークンは、ERC-721トークンを受け取り、保持し、転送できるERC-721トークンです。

ERC-721トークンをトップダウン型の合成可能トークンに転送する方法は2つあります:

1. `function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes data)`関数を使う。`_to`引数がトップダウン型の合成可能コントラクトアドレスになります。`bytes data`引数には、ERC-721トークンが転送されるトップダウン型の合成可能トークンのトークンIDの整数値が含まれます。
2. ERC-721トークンコントラクトで`approve`を呼び、その後合成可能コントラクトで`getChild`を呼ぶ。

1つ目の方法は、`safeTransferFrom`関数を持つERC-721コントラクト用です。2つ目の方法は、Cryptokittiesのようにこの関数を持たないコントラクト用です。

ERC-721トークン3番を、ユーザーアドレスからトップダウン型の合成可能トークン6番に転送する例は以下の通りです:

```solidity
uint256 tokenId = 6;
bytes memory tokenIdBytes = new bytes(32);
assembly { mstore(add(tokenIdBytes, 32), tokenId) }
ERC721(contractAddress).safeTransferFrom(userAddress, composableAddress, 3, tokenIdBytes);
```

ERC-721トップダウン型の合成可能コントラクトは、必ず`ERC998ERC721TopDown`インターフェースを実装しなければなりません。

`ERC998ERC721TopDownEnumerable`および`ERC998ERC20TopDownEnumerable`インターフェースは任意です。

```solidity
pragma solidity ^0.4.24;

/// @title `ERC998ERC721` トップダウン型の合成可能な非代替性トークン
/// @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-998.mdを参照
///  注: このインターフェースのERC-165識別子は0xcde244d9
interface ERC998ERC721TopDown {
/// @dev トークンが子トークンを受け取ったときに発行されるイベント
  /// @param _from 子トークンの前の所有者
  /// @param _toTokenId 子トークンを受け取るトークン
  event ReceivedChild(
    address indexed _from, 
    uint256 indexed _toTokenId, 
    address indexed _childContract, 
    uint256 _childTokenId
  );
  
  /// @dev 子トークンがトークンから別のアドレスに転送されたときに発行されるイベント
  /// @param _fromTokenId 子トークンが転送されるトークン
  /// @param _to 子トークンの新しい所有者アドレス
  event TransferChild(
    uint256 indexed _fromTokenId, 
    address indexed _to, 
    address indexed _childContract, 
    uint256 _childTokenId
  );

  /// @notice トークンIDのルート所有者を取得する
  /// @param _tokenId ルート所有者アドレスを問い合わせるトークンID
  /// @return rootOwner トークンとERC-998マジック値の最上位の所有者
  function rootOwnerOf(uint256 _tokenId) public view returns (bytes32 rootOwner);
  
  /// @notice 子トークンのルート所有者を取得する
  /// @param _childContract 子トークンのコントラクトアドレス
  /// @param _childTokenId 子トークンのトークンID
  /// @return rootOwner トークンとERC-998マジック値の最上位の所有者
  function rootOwnerOfChild(
    address _childContract, 
    uint256 _childTokenId
  ) 
    public 
    view
    returns (bytes32 rootOwner);
  
  /// @notice 子トークンの親トークンIDを取得する
  /// @param _childContract 子トークンのコントラクトアドレス
  /// @param _childTokenId 子トークンのトークンID
  /// @return parentTokenOwner 親トークンの所有者アドレスとERC-998マジック値
  /// @return parentTokenId 子トークンの親トークンID
  function ownerOfChild(
    address _childContract, 
    uint256 _childTokenId
  ) 
    external 
    view 
    returns (
      bytes32 parentTokenOwner, 
      uint256 parentTokenId
    );
  
  /// @notice トークンが子トークンを受け取る
  /// @param _operator 転送を引き起こしたアドレス
  /// @param _from 子トークンの前の所有者
  /// @param _childTokenId 親トークンに転送されるトークン
  /// @param _data 最初の32バイトには、受け取る親トークンIDの整数が含まれる
  function onERC721Received(
    address _operator, 
    address _from, 
    uint256 _childTokenId, 
    bytes _data
  ) 
    external 
    returns(bytes4);
    
  /// @notice トップダウン型の合成可能トークンから子トークンを転送する
  /// @param _fromTokenId 子トークンを転送する親トークン
  /// @param _to 子トークンを受け取るアドレス
  /// @param _childContract 子トークンのERC-721コントラクト
  /// @param _childTokenId 転送されるトークンのトークンID
  function transferChild(
    uint256 _fromTokenId,
    address _to, 
    address _childContract, 
    uint256 _childTokenId
  ) 
    external;
  
  /// @notice トップダウン型の合成可能トークンから子トークンを安全に転送する
  /// @param _fromTokenId 子トークンを転送する親トークン
  /// @param _to 子トークンを受け取るアドレス
  /// @param _childContract 子トークンのERC-721コントラクト
  /// @param _childTokenId 転送されるトークンのトークンID
  function safeTransferChild(
    uint256 _fromTokenId,
    address _to, 
    address _childContract, 
    uint256 _childTokenId
  ) 
    external;
  
  /// @notice トップダウン型の合成可能トークンから子トークンを安全に転送する
  /// @param _fromTokenId 子トークンを転送する親トークン
  /// @param _to 子トークンを受け取るアドレス
  /// @param _childContract 子トークンのERC-721コントラクト
  /// @param _childTokenId 転送されるトークンのトークンID
  /// @param _data 指定のフォーマットはない追加のデータ
  function safeTransferChild(
    uint256 _fromTokenId,
    address _to, 
    address _childContract, 
    uint256 _childTokenId, 
    bytes _data
  ) 
    external;
  
  /// @notice トップダウン型の合成可能トークンからボトムアップ型の子トークンを、別のERC-721トークンに転送する
  /// @param _fromTokenId 子トークンを転送する親トークン
  /// @param _toContract 受け取るトークンのERC-721コントラクト
  /// @param _toTokenId 受け取るトークン
  /// @param _childContract 子トークンのボトムアップ型のコントラクト
  /// @param _childTokenId 転送されるトークン
  /// @param _data 指定のフォーマットはない追加のデータ
  function transferChildToParent(
    uint256 _fromTokenId, 
    address _toContract, 
    uint256 _toTokenId, 
    address _childContract, 
    uint256 _childTokenId, 
    bytes _data
  ) 
    external;
  
  /// @notice ERC-721コントラクトから子トークンを取得する
  /// @param _from 子トークンの所有者アドレス
  /// @param _tokenId 親トークンになるトークン
  /// @param _childContract 子トークンのERC-721コントラクト
  /// @param _childTokenId 子トークンのトークンID
  function getChild(
    address _from, 
    uint256 _tokenId, 
    address _childContract, 
    uint256 _childTokenId
  ) 
    external;
}
```

#### `rootOwnerOf` 1

```solidity
/// @notice トークンIDのルート所有者を取得する
/// @param _tokenId ルート所有者アドレスを問い合わせるトークンID
/// @return rootOwner トークンとERC-998マジック値の最上位の所有者
function rootOwnerOf(uint256 _tokenId) public view returns (bytes32 rootOwner);
```

この関数は、`_tokenId`のルート所有者アドレスを見つけるまでトークンの所有者を辿ります。

`rootOwner`の最初の4バイトには、ERC-998マジック値`0xcd740db5`が含まれています。最後の20バイトにはルート所有者アドレスが含まれています。

マジック値が返されるのは、この関数がコントラクトで呼び出された際に、コントラクトに`rootOwnerOf`関数があるかどうかが分からない場合に備えてのものです。マジック値は、有効な返り値を確実に受け取るために使用されます。

コントラクトに`rootOwnerOf`関数があるかどうかが分からない場合は、`rootOwner`の返り値の最初の4バイトを`0xcd740db5`と比較する必要があります。

`0xcd740db5`は以下と等しくなります:

```solidity
this.rootOwnerOf.selector ^ this.rootOwnerOfChild.selector ^ 
this.tokenOwnerOf.selector ^ this.ownerOfChild.selector;
```

`rootOwnerOf`の返り値の例は以下の通りです:
`0xcd740db50000000000000000e5240103e1ff986a2c8ae6b6728ffe0d9a395c59`

#### rootOwnerOfChild

```solidity
/// @notice 子トークンのルート所有者を取得する
/// @param _childContract 子トークンのコントラクトアドレス
/// @param _childTokenId 子トークンのトークンID
/// @return rootOwner トークンとERC-998マジック値の最上位の所有者
function rootOwnerOfChild(
  address _childContract, 
  uint256 _childTokenId
) 
  public 
  view 
  returns (bytes32 rootOwner);
```

この関数は、指定された子トークンのルート所有者アドレスを見つけるまでトークンの所有者を辿ります。

`rootOwner`の最初の4バイトには、ERC-998マジック値`0xcd740db5`が含まれています。最後の20バイトにはルート所有者アドレスが含まれています。

マジック値が返されるのは、この関数がコントラクトで呼び出された際に、コントラクトに`rootOwnerOfChild`関数があるかどうかが分からない場合に備えてのものです。マジック値は、有効な返り値を確実に受け取るために使用されます。

コントラクトに`rootOwnerOfChild`関数があるかどうかが分からない場合は、`rootOwner`の返り値の最初の4バイトを`0xcd740db5`と比較する必要があります。

#### ownerOfChild

```solidity
/// @notice 子トークンの親トークンIDを取得する
/// @param _childContract 子トークンのコントラクトアドレス
/// @param _childTokenId 子トークンのトークンID
/// @return parentTokenOwner 親トークンの所有者アドレスとERC-998マジック値
/// @return parentTokenId 子トークンの親トークンID
function ownerOfChild(
  address _childContract, 
  uint256 _childTokenId
) 
  external 
  view 
  returns (
    address parentTokenOwner, 
    uint256 parentTokenId
  );
```

この関数は、子トークンの親トークンIDと親トークンの所有者アドレスを取得するために使用されます。

`parentTokenOwner`の最初の4バイトには、ERC-998マジック値`0xcd740db5`が含まれています。最後の20バイトには親トークンの所有者アドレスが含まれています。

マジック値が返されるのは、この関数がコントラクトで呼び出された際に、コントラクトに`ownerOfChild`関数があるかどうかが分からない場合に備えてのものです。マジック値は、有効な返り値を確実に受け取るために使用されます。

コントラクトに`ownerOfChild`関数があるかどうかが分からない場合は、`parentTokenOwner`の返り値の最初の4バイトを`0xcd740db5`と比較する必要があります。

#### `onERC721Received`

```solidity
/// @notice トークンが子トークンを受け取る
/// @param _operator 転送を引き起こしたアドレス
/// @param _from 子トークンの前の所有者
/// @param _childTokenId 親トークンに転送されるトークン
/// @param _data 最初の32バイトには、受け取る親トークンIDの整数が含まれる
function onERC721Received(
  address _operator, 
  address _from, 
  uint256 _childTokenId, 
  bytes _data
) 
  external 
  returns(bytes4);
```

これはERC-721標準で定義された関数です。`safeTransferFrom`が呼び出された際に、ERC-721コントラクトでこの関数が呼び出されます。`bytes _data`引数には、1～32バイトの整数値として、ERC-721トークンが転送される親トークンIDが含まれています。

`onERC721Received`関数は、ERC-721トークンがトップダウン型の合成可能トークンに転送されたことを、合成可能コントラクトに通知し、どのトークンIDが親トークンIDであるかを伝えるものです。

`onERC721Received`関数の返り値は、マジック値`0x150b7a02`で、これは`bytes4(keccak256(abi.encodePacked("onERC721Received(address,address,uint256,bytes)")))`と等しくなります。

#### transferChild

```solidity
/// @notice トップダウン型の合成可能トークンから子トークンを転送する
/// @param _fromTokenId 子トークンを転送する親トークン
/// @param _to 子トークンを受け取るアドレス
/// @param _childContract 子トークンのERC-721コントラクト
/// @param _childTokenId 転送されるトークンのトークンID
function transferChild(
  uint256 _fromTokenId,
  address _to, 
  address _childContract, 
  uint256 _childTokenId
) 
  external;
```

この関数は、`msg.sender`を認証し、トップダウン型の合成可能トークンから別のアドレスに子トークンを転送します。

この関数内で以下の呼び出しを行います:

```solidity
ERC721(_childContract).transferFrom(this, _to, _childTokenId);
```

#### safeTransferChild 1

```solidity
/// @notice トップダウン型の合成可能トークンから子トークンを安全に転送する
/// @param _fromTokenId 子トークンを転送する親トークン
/// @param _to 子トークンを受け取るアドレス
/// @param _childContract 子トークンのERC-721コントラクト
/// @param _childTokenId 転送されるトークンのトークンID
function safeTransferChild(
  uint256 _fromTokenId,
  address _to, 
  address _childContract, 
  uint256 _childTokenId
) 
  external;
```

この関数は、`msg.sender`を認証し、トップダウン型の合成可能トークンから別のアドレスに子トークンを安全に転送します。

この関数内で以下の呼び出しを行います:

```solidity
ERC721(_childContract).safe
TransferFrom(this, _to, _childTokenId);
```

#### safeTransferChild 2

```solidity
/// @notice トップダウン型の合成可能トークンから子トークンを別のアドレスまたは別のトップダウン型の合成可能トークンに安全に転送する
/// @param _fromTokenId 子トークンを転送する親トークン
/// @param _to 子トークンを受け取るアドレス
/// @param _childContract 子トークンのERC721コントラクト
/// @param _childTokenId 転送されるトークンのトークンID
/// @param _data 指定のフォーマットはない追加のデータ、別のトップダウン型の合成可能トークンのトークンIDを指定できる
function safeTransferChild(
  uint256 _fromTokenId,
  address _to, 
  address _childContract, 
  uint256 _childTokenId, 
  bytes _data
) 
  external;
```

この関数は、`msg.sender`を認証し、トップダウン型の合成可能トークンから別のアドレスまたは別のトップダウン型の合成可能トークンに子トークンを安全に転送します。

`_to`がトップダウン型の合成可能コントラクトで、`bytes _data`に整数が指定されている場合、子トークンは別のトップダウン型の合成可能トークンに転送されます。

この関数内で以下の呼び出しを行います:

```solidity
ERC721(_childContract).safeTransferFrom(this, _to, _childTokenId, _data);
```

#### transferChildToParent

```solidity
/// @notice トップダウン型の合成可能トークンからボトムアップ型の子トークンを、別のERC-721トークンに転送する
/// @param _fromTokenId 子トークンを転送する親トークン
/// @param _toContract 受け取るトークンのERC-721コントラクト
/// @param _toToken 受け取るトークン
/// @param _childContract 子トークンのボトムアップ型のコントラクト
/// @param _childTokenId 転送されるトークン
/// @param _data 指定のフォーマットはない追加のデータ
function transferChildToParent(
  uint256 _fromTokenId, 
  address _toContract, 
  uint256 _toTokenId, 
  address _childContract, 
  uint256 _childTokenId, 
  bytes _data
) 
  external
```

この関数は、`msg.sender`を認証し、トップダウン型の合成可能トークンからボトムアップ型の子トークンを、別のERC-721トークンに転送します。この関数は、子トークンがボトムアップ型の合成可能トークンである場合にのみ使用できます。トップダウン型の合成可能トークンからボトムアップ型のトークンを、1つの取引でERC-721トークンに転送するために設計されています。

この関数内で以下の呼び出しを行います:

```solidity
ERC998ERC721BottomUp(_childContract).transferToParent(
  address(this), 
  _toContract, 
  _toTokenId, 
  _childTokenId, 
  _data
);
```

#### getChild 

```solidity
/// @notice ERC-721コントラクトから子トークンを取得する
/// @param _from 子トークンの所有者アドレス
/// @param _tokenId 親トークンになるトークン
/// @param _childContract 子トークンのERC-721コントラクト
/// @param _childTokenId 子トークンのトークンID
function getChild(
  address _from, 
  uint256 _tokenId, 
  address _childContract, 
  uint256 _childTokenId
) 
  external;
```

この関数は、ERC-721トークンのコントラクトに`safeTransferChild(uint256 _fromTokenId, address _to, address _childContract, uint256 _childTokenId, bytes _data)`関数がない場合に使用されます。

この関数での転送は2つのステップで行われます:

1. ERC-721トークンの所有者が、ERC-721コントラクトでトップダウン型の合成可能コントラクトに`approve`または`setApprovalForAll`を呼ぶ。
2. ERC-721トークンの所有者が、トップダウン型の合成可能コントラクトで`getChild`を呼ぶ。

`getChild`関数は、`msg.sender`がERC-721トークンのコントラクトで所有者であるか、承認されているか、オペレーターであることを認証しなければなりません。

#### ERC-721トップダウン型の合成可能の列挙

トップダウン型の合成可能の列挙のためのオプションのインターフェース:

```solidity
///  @dev このインターフェースのERC-165識別子は0xa344afe4
interface ERC998ERC721TopDownEnumerable {

  /// @notice トークンIDが所有する子コントラクトの総数を取得する
  /// @param _tokenId 子トークンを持つ親トークン
  /// @return uint256 トークンIDが所有する子コントラクトの総数
  function totalChildContracts(uint256 _tokenId) external view returns(uint256);
  
  /// @notice トークンIDとインデックスから子コントラクトを取得する
  /// @param _tokenId 子トークンを持つ親トークン
  /// @param _index 子コントラクトの位置インデックス
  /// @return childContract 指定されたトークンIDとインデックスの子コントラクト
  function childContractByIndex(
    uint256 _tokenId, 
    uint256 _index
  ) 
    external 
    view 
    returns (address childContract);
  
  /// @notice トークンIDが所有する、特定の子コントラクト内の子トークンの総数を取得する
  /// @param _tokenId 子トークンを持つ親トークン
  /// @param _childContract 子トークンを含む子コントラクト
  /// @return uint256 トークンIDが所有する、子コントラクト内の子トークンの総数
  function totalChildTokens(
    uint256 _tokenId, 
    address _childContract
  ) 
    external 
    view 
    returns(uint256);
  
  /// @notice トークンIDが所有する、特定の子コントラクトの特定のインデックスの子トークンを取得する
  /// @param _tokenId 子トークンを持つ親トークン
  /// @param _childContract 子トークンを含む子コントラクト
  /// @param _index 子トークンのインデックス位置
  /// @return childTokenId 親トークン、子トークン、インデックスの子トークンID
  function childTokenByIndex(
    uint256 _tokenId, 
    address _childContract, 
    uint256 _index
  )
    external 
    view 
    returns (uint256 childTokenId);
}
```

### ERC-20トップダウン型の合成可能

ERC-20トップダウン型の合成可能トークンは、ERC-20トークンのコンテナとして機能します。
  
ERC-20トップダウン型の合成可能トークンは、ERC-20トークンを受け取り、保持し、転送できるERC-721トークンです。

ERC-20トークンをERC-20トップダウン型の合成可能トークンに転送する方法は2つあります:

1. `transfer(address _to, uint256 _value, bytes _data);`関数を`ERC-223`コントラクトから使う。`_to`引数がERC-20トップダウン型の合成可能コントラクトアドレスになります。`_value`引数がどれだけのERC-20トークンを転送するかを指定します。`bytes`引数には、ERC-20トークンを受け取るトップダウン型の合成可能トークンのトークンIDの整数値が含まれます。
2. ERC-20コントラクトでERC-20トップダウン型の合成可能コントラクトに`approve`を呼び、その後合成可能コントラクトで`getERC20(address _from, uint256 _tokenId, address _erc20Contract, uint256 _value)`を呼ぶ。

1つ目の方法は、`ERC-223`標準をサポートしているERC-20コントラクト用です。2つ目の方法は、そうでないコントラクト用です。

ERC-20トップダウン型の合成可能トークンは、以下のインターフェースを実装します:
  
```solidity
/// @title `ERC998ERC20` トップダウン型の合成可能な代替性トークン
/// @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-998.mdを参照
///  注: このインターフェースのERC-165識別子は0x7294ffed
interface ERC998ERC20TopDown {

  /// @dev トークンがERC-20トークンを受け取ったときに発行されるイベント
  /// @param _from ERC-20トークンの前の所有者
  /// @param _toTokenId ERC-20トークンを受け取るトークン
  /// @param _erc20Contract ERC-20コントラクト
  /// @param _value 受け取ったERC-20トークンの数
  event ReceivedERC20(
    address indexed _from, 
    uint256 indexed _toTokenId, 
    address indexed _erc20Contract, 
    uint256 _value
  );
  
  /// @dev トークンがERC-20トークンを転送したときに発行されるイベント
  /// @param _tokenId ERC-20トークンを所有していたトークン
  /// @param _to ERC-20トークンを受け取るアドレス
  /// @param _erc20Contract ERC-20コントラクト
  /// @param _value 転送したERC-20トークンの数
  event TransferERC20(
    uint256 indexed _fromTokenId, 
    address indexed _to, 
    address indexed _erc20Contract, 
    uint256 _value
  );

  /// @notice トークンがERC-20トークンを受け取る
  /// @param _from ERC-20トークンの前の所有者
  /// @param _value 受け取ったERC-20トークンの数
  /// @param _data 最初の32バイトには、受け取るトークンIDの整数が含まれる
  function tokenFallback(address _from, uint256 _value, bytes _data) external;
  
  /// @notice 特定のトークンとERC-20コントラクトのERC-20トークンの残高を確認する
  /// @param _tokenId ERC-20トークンを所有するトークン
  /// @param _erc20Contract ERC-20コントラクト
  /// @return トークンが特定のERC-20コントラクトから所有しているERC-20トークンの数
  function balanceOfERC20(
    uint256 _tokenId, 
    address _erc20Contract
  ) 
    external 
    view 
    returns(uint256);
  
  /// @notice ERC-20トークンをアドレスに転送する
  /// @param _tokenId トークンから転送する
  /// @param _value ERC-20トークンを送信するアドレス
  /// @param _erc20Contract ERC-20コントラクト
  /// @param _value 転送するERC-20トークンの数
  function transferERC20(
    uint256 _tokenId, 
    address _to, 
    address _erc20Contract, 
    uint256 _value
  ) 
    external;
  
  /// @notice ERC-20トークンをアドレスまたはERC-20トップダウン型の合成可能トークンに転送する
  /// @param _tokenId トークンから転送する
  /// @param _value ERC-20トークンを送信するアドレス
  /// @param _erc223Contract `ERC-223`トークンコントラクト
  /// @param _value 転送するERC-20トークンの数
  /// @param _data 指定のフォーマットはない追加のデータ、別のトップダウン型の合成可能トークンのトークンIDを指定できる
  function transferERC223(
    uint256 _tokenId, 
    address _to, 
    address _erc223Contract, 
    uint256 _value, 
    bytes _data
  )
    external;
  
  /// @notice ERC-20コントラクトからERC-20トークンを取得する
  /// @param _from ERC-20トークンの現在の所有者アドレス
  /// @param _tokenId ERC-20トークンを転送するトークン
  /// @param _erc20Contract ERC-20トークンコントラクト
  /// @param _value 転送するERC-20トークンの数
  function getERC20(
    address _from, 
    uint256 _tokenId, 
    address _erc20Contract, 
    uint256 _value
  ) 
    external;
}
```

#### tokenFallback

```solidity
/// @notice トークンがERC-20トークンを受け取る
/// @param _from ERC-20トークンの前の所有者
/// @param _value 受け取ったERC-20トークンの数
/// @param _data 最初の32バイトには、受け取るトークンIDの整数が含まれる
function tokenFallback(address _from, uint256 _value, bytes _data) external;  
```

この関数は、ERC-20の拡張である`ERC-223`から来ています。ERC-20トークンが転送された際に、受け取り側のコントラクトでこの関数が呼び出されます。この関数は、ERC-20トップダウン型の合成可能コントラクトが、どのトークンがERC-20トークンを受け取ったかを通知される仕組みです。`_data`パラメータで、どのトークンがERC-20トークンを受け取ったかが指定されます。

#### `balanceOf
ERC20`

```solidity
/// @notice 特定のトークンとERC-20コントラクトのERC-20トークンの残高を確認する
/// @param _tokenId ERC-20トークンを所有するトークン
/// @param _erc20Contract ERC-20コントラクト
/// @return トークンが特定のERC-20コントラクトから所有しているERC-20トークンの数
function balanceOfERC20(
  uint256 _tokenId, 
  address _erc20Contract
) 
  external 
  view 
  returns(uint256);
```

トークンが特定のERC-20コントラクトから所有しているERC-20トークンの残高を取得します。

#### `transferERC20`

```solidity
/// @notice ERC-20トークンをアドレスに転送する
/// @param _tokenId トークンから転送する
/// @param _value ERC-20トークンを送信するアドレス
/// @param _erc20Contract ERC-20コントラクト
/// @param _value 転送するERC-20トークンの数
function transferERC20(
  uint256 _tokenId, 
  address _to, 
  address _erc20Contract, 
  uint256 _value
)
  external;
```

トークンからアドレスにERC-20トークンを転送するために使用されます。この関数は`ERC20(_erc20Contract).transfer(_to, _value)`を呼び出します。

この関数は`msg.sender`を認証しなければなりません。

#### `transferERC223`

```solidity
  /// @notice ERC-20トークンをアドレスまたはERC-20トップダウン型の合成可能トークンに転送する
  /// @param _tokenId トークンから転送する
  /// @param _value ERC-20トークンを送信するアドレス
  /// @param _erc223Contract `ERC-223`トークンコントラクト
  /// @param _value 転送するERC-20トークンの数
  /// @param _data 指定のフォーマットはない追加のデータ、別のトップダウン型の合成可能トークンのトークンIDを指定できる
  function transferERC223(
    uint256 _tokenId, 
    address _to, 
    address _erc223Contract, 
    uint256 _value, 
    bytes _data
  )
    external;
```

この関数は`ERC-223`から来ています。トークンからアドレスまたは別のトークンにERC-20トークンを転送するために使用されます。`_data`引数に整数のトークンIDを入れることで、別のトップダウン型の合成可能トークンに転送できます。

この関数は`msg.sender`を認証しなければなりません。

#### `getERC20`

```solidity
/// @notice ERC-20コントラクトからERC-20トークンを取得する
/// @param _from ERC-20トークンの現在の所有者アドレス
/// @param _tokenId ERC-20トークンを転送するトークン
/// @param _erc20Contract ERC-20トークンコントラクト
/// @param _value 転送するERC-20トークンの数
function getERC20(
  address _from, 
  uint256 _tokenId, 
  address _erc20Contract, 
  uint256 _value
) 
  external;
```

ERC-20トークンをERC-20トップダウン型の合成可能トークンに転送する際に、ERC-20コントラクトに`transferERC223(uint256 _tokenId, address _to, address _erc223Contract, uint256 _value, bytes _data)`関数がない場合に使用されます。

この関数を使う前に、ERC-20トップダウン型の合成可能コントラクトアドレスがERC-20コントラクトで承認されている必要があります。

この関数は、`msg.sender`が`_from`と等しいか、ERC-20コントラクトで承認されていることを認証しなければなりません。

#### ERC-20トップダウン型の合成可能の列挙

トップダウン型の合成可能の列挙のためのオプションのインターフェース:

```solidity
/// @dev このインターフェースのERC-165識別子は0xc5fd96cd
interface ERC998ERC20TopDownEnumerable {
  
  /// @notice トークンが所有しているERC-20コントラクトの数を取得する
  /// @param _tokenId ERC-20トークンを所有するトークン
  /// @return uint256 ERC-20コントラクトの数
  function totalERC20Contracts(uint256 _tokenId) external view returns(uint256);
  
  /// @notice トークンが所有しているERC-20コントラクトをインデックスから取得する
  /// @param _tokenId ERC-20トークンを所有するトークン
  /// @param _index ERC-20コントラクトの位置インデックス
  /// @return address ERC-20コントラクト
  function erc20ContractByIndex(
    uint256 _tokenId, 
    uint256 _index
  ) 
    external 
    view 
    returns(address);
}
```

### ERC-721ボトムアップ型の合成可能

ERC-721ボトムアップ型の合成可能トークンは、他のERC-721トークンに自身を付加するERC-721トークンです。

ERC-721ボトムアップ型の合成可能コントラクトは、トークンの所有者アドレスと、親トークンIDがあれば、それも保存します。

```solidity
/// @title `ERC998ERC721` ボトムアップ型の合成可能な非代替性トークン
/// @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-998.mdを参照
///  注: このインターフェースのERC-165識別子は0xa1b23002
interface ERC998ERC721BottomUp {

  /// @dev トークンがERC-721トークンに転送されたときに発行されるイベント
  /// @param _toContract トークンが転送されたコントラクト
  /// @param _toTokenId トークンが転送された先のトークン
  /// @param _tokenId 転送されたトークン
  event TransferToParent(
    address indexed _toContract, 
    uint256 indexed _toTokenId, 
    uint256 _tokenId
  );
  
  /// @dev トークンがERC-721トークンから転送されたときに発行されるイベント
  /// @param _fromContract トークンが転送された元のコントラクト
  /// @param _fromTokenId トークンが転送された元のトークン
  /// @param _tokenId 転送されたトークン
  event TransferFromParent(
    address indexed _fromContract, 
    uint256 indexed _fromTokenId, 
    uint256 _tokenId
  );
  
  /// @notice トークンIDのルート所有者を取得する
  /// @param _tokenId ルート所有者アドレスを問い合わせるトークンID
  /// @return rootOwner トークンとERC-998マジック値の最上位の所有者
  function rootOwnerOf(uint256 _tokenId) external view returns (bytes32 rootOwner);

  /// @notice トークンの所有者アドレスと親トークン(ある場合)を取得する
  /// @param _tokenId 問い合わせるトークンID
  /// @return tokenOwner トークンの所有者アドレス
  /// @return parentTokenId 親トークンのトークンIDとERC-998マジック値
  /// @return isParent parentTokenIdが有効な親トークンIDであればtrue、そうでなければfalse
  function tokenOwnerOf(
    uint256 _tokenId
  )
    external 
    view
    returns (
      bytes32 tokenOwner, 
      uint256 parentTokenId, 
      bool isParent
    );
 
  /// @notice トークンをオーナーアドレスからトークンに転送する
  /// @param _from オーナーアドレス
  /// @param _toContract 受け取るトークンのERC-721コントラクト
  /// @param _toToken 受け取るトークン
  /// @param _data 指定のフォーマットはない追加のデータ
  function transferToParent(
    address _from, 
    address _toContract, 
    uint256 _toTokenId, 
    uint256 _tokenId, 
    bytes _data
  )
    external;
   
  /// @notice トークンをトークンから別のアドレスに転送する
  /// @param _fromContract 所有コントラクトのアドレス
  /// @param _fromTokenId 所有トークン
  /// @param _to トークンが転送されるアドレス
  /// @param _tokenId 転送されるトークン
  /// @param _data 指定のフォーマットはない追加のデータ
  function transferFromParent(
    address _fromContract, 
    uint256 _fromTokenId, 
    address _to, 
    uint256 _tokenId, 
    bytes _data
  )
    external;
  
  /// @notice トークンをトークンから別のトークンに転送する
  /// @param _fromContract 所有コントラクトのアドレス
  /// @param _fromTokenId 所有トークン
  /// @param _toContract 受け取るトークンのERC-721コントラクト
  /// @param _toToken 受け取るトークン
  /// @param _tokenId 転送されるトークン
  /// @param _data 指定のフォーマットはない追加のデータ
  function transferAsChild(
    address _fromContract, 
    uint256 _fromTokenId, 
    address _toContract, 
    uint256 _toTokenId, 
    uint256 _tokenId, 
    bytes _data
  )
    external;
}
```

#### `rootOwnerOf`

```solidity
/// @notice トークンIDのルート所有者を取得する
/// @param _tokenId ルート所有者アドレスを問い合わせるトークンID
/// @return rootOwner トークンとERC-998マジック値の最上位の所有者
function rootOwnerOf(uint256 _tokenId) public view returns (bytes32 rootOwner);
```

この関数は、`_tokenId`のルート所有者アドレスを見つけるまでトークンの所有者を辿ります。

`rootOwner`の最初の4バイトには、ERC-998マジック値`0xcd740db5`が含まれています。最後の20バイトにはルート所有者アドレスが含まれています。

マジック値が返されるのは、この関数がコントラクトで呼び出された際に、コントラクトに`rootOwnerOf`関数があるかどうかが分からない場合に備えてのものです。マジック値は、有効な返り値を確実に受け取るために使用されます。

コントラクトに`rootOwnerOf`関数があるかどうかが分からない場合は、`rootOwner`の返り値の最初の4バイトを`0xcd740db5`と比較する必要があります。

`0xcd740db5`は以下と等しくなります:

```solidity
this.rootOwnerOf.selector ^ this.rootOwnerOfChild.selector ^ 
this.tokenOwnerOf.selector ^ this.ownerOfChild.selector;
```

`rootOwnerOf`の返り値の例は以下の通りです:
`0xcd740db50000000000000000e5240103e1ff986a2c8ae6b6728ffe0d9a395c59`

#### tokenOwnerOf

```solidity
/// @notice トークンの所有者アドレスと親トークン(ある場合)を取得する
/// @param _tokenId 問い合わせるトークンID
/// @return tokenOwner トークンの所有者アドレスとERC-998マジック値
/// @return parentTokenId 親トークンのトークンID
/// @return isParent parentTokenIdが有効な親トークンIDであればtrue、そうでなければfalse
function tokenOwnerOf(
  uint256 _tokenId
)
  external 
  view 
  returns (
    bytes32 tokenOwner, 
    uint256 parentTokenId, 
    bool isParent
  );
```

このコントラクトに保存されているトークンの所有者アドレスと親トークンIDを取得するために使用されます。

`isParent`がtrueの場合、`tokenOwner`はERC-721コントラクトアドレスで、`parentTokenId`は有効な親トークンIDです。`isParent`がfalseの場合、`tokenOwner`はユーザーアドレスで、`parentTokenId`に有効な親トークンIDは含まれていません。

`tokenOwner`の最初の4バイトには、ERC-998マジック値`0xcd740db5`が含まれています。最後の20バイトにはトークンの所有者アドレスが含まれています。

マジック値が返されるのは、この関数がコントラクトで呼び出された際に、コントラクトに`tokenOwnerOf`関数があるかどうかが分からない場合に備えてのものです。マジック値は、有効な返り値を確実に受け取るために使用されます。

コントラクトに`rootOwnerOf`関数があるかどうかが分からない場合は、`tokenOwner`の返り値の最初の4バイトを`0xcd740db5`と比較する必要があります。

#### transferToParent

```solidity
/// @notice トークンをオーナーアドレスからトークンに転送する
/// @param _from オーナーアドレス
/// @param _toContract 受け取るトークンのERC-721コントラクト
/// @param _toToken 受け取るトークン
/// @param _data 指定のフォーマットはない追加のデータ
function transferToParent(
  address _from, 
  address _toContract, 
  uint256 _toTokenId, 
  uint256 _tokenId, 
  bytes _data
)
  external;
```

この関数は、アドレスからトークンにトークンを転送するために使用されます。`msg.sender`は認証されなければなりません。

この関数は、`
_toToken`が`_toContract`に存在することを確認し、存在しない場合はスローしなければなりません。

#### transferFromParent

```solidity
/// @notice トークンをトークンから別のアドレスに転送する
/// @param _fromContract 所有コントラクトのアドレス
/// @param _fromTokenId 所有トークン
/// @param _to トークンが転送されるアドレス
/// @param _tokenId 転送されるトークン
/// @param _data 指定のフォーマットはない追加のデータ
function transferFromParent(
  address _fromContract, 
  uint256 _fromTokenId, 
  address _to, 
  uint256 _tokenId, 
  bytes _data
)
  external;
```

この関数は、トークンから別のアドレスにトークンを転送するために使用されます。`msg.sender`は認証されなければなりません。

この関数は、`_fromContract`と`_fromTokenId`が`_tokenId`を所有していることを確認し、そうでない場合はスローしなければなりません。

#### transferAsChild

```solidity
/// @notice トークンをトークンから別のトークンに転送する
/// @param _fromContract 所有コントラクトのアドレス
/// @param _fromTokenId 所有トークン
/// @param _toContract 受け取るトークンのERC-721コントラクト
/// @param _toToken 受け取るトークン
/// @param _tokenId 転送されるトークン
/// @param _data 指定のフォーマットはない追加のデータ
function transferAsChild(
  address _fromContract, 
  uint256 _fromTokenId, 
  address _toContract, 
  uint256 _toTokenId, 
  uint256 _tokenId, 
  bytes _data
)
  external;
```

この関数は、トークンからトークンにトークンを転送するために使用されます。`msg.sender`は認証されなければなりません。

この関数は、`_toToken`が`_toContract`に存在することを確認し、存在しない場合はスローしなければなりません。

この関数は、`_fromContract`と`_fromTokenId`が`_tokenId`を所有していることを確認し、そうでない場合はスローしなければなりません。

#### ERC-721ボトムアップ型の合成可能の列挙

ボトムアップ型の合成可能の列挙のためのオプションのインターフェース:

```solidity
/// @dev このインターフェースのERC-165識別子は0x8318b539
interface ERC998ERC721BottomUpEnumerable {
  
  /// @notice 親トークンが所有するERC-721トークンの数を取得する
  /// @param _parentContract 親ERC-721トークンのコントラクト
  /// @param _parentTokenId 親トークンが所有するトークン
  //  @return uint256 親トークンが所有するERC-721トークンの数
  function totalChildTokens(
    address _parentContract, 
    uint256 _parentTokenId
  ) 
    external 
    view 
    returns (uint256);
  
  /// @notice インデックスから子トークンを取得する
  /// @param _parentContract 親ERC-721トークンのコントラクト
  /// @param _parentTokenId 親トークンが所有するトークン
  /// @param _index 子トークンの位置インデックス
  /// @return uint256 親トークンが所有する子トークンのトークンID
  function childTokenByIndex(
    address _parentContract, 
    uint256 _parentTokenId, 
    uint256 _index
  ) 
    external 
    view 
    returns (uint256);
}
```

### ERC-20ボトムアップ型の合成可能

ERC-20ボトムアップ型の合成可能トークンは、ERC-721トークンに自身を付加するERC-20トークン、または通常のERC-20トークンのようにユーザーアドレスに所有されるトークンです。

ERC-721トークンに所有されている場合、ERC-20ボトムアップ型の合成可能コントラクトは、トークンの所有者アドレスと親トークンIDを保存します。ERC-20ボトムアップ型の合成可能トークンは、親トークンの残高の照会や、親トークンから/親トークンへの転送などの機能を追加しています。

この機能は、ユーザーアドレスの残高を追跡する標準のマッピングに加えて、1つの追加のマッピングを追跡することで実装できます。

```solidity
/// @dev このマッピングは標準のERC20/`ERC-223`の所有権を追跡します。アドレスが特定の量のトークンを所有しています。
mapping(address => uint) userBalances;

/// @dev この追加のマッピングはERC-998の所有権を追跡します。ERC-721トークンが特定の量のトークンを所有しています。contractAddress => tokenId => balance
mapping(address => mapping(uint => uint)) nftBalances;
```

完全なインターフェースは以下の通りです。

```solidity
/// @title `ERC998ERC20` ボトムアップ型の合成可能な代替性トークン
/// @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-998.mdを参照
/// 注: このインターフェースのERC-165識別子は0xffafa991
interface ERC998ERC20BottomUp {
  
  /// @dev トークンがERC-721トークンに転送されたときに発行されるイベント
  /// @param _toContract トークンが転送されたコントラクト
  /// @param _toTokenId トークンが転送された先のトークン
  /// @param _amount 転送されたトークンの量
  event TransferToParent(
    address indexed _toContract, 
    uint256 indexed _toTokenId, 
    uint256 _amount
  );

  /// @dev トークンがERC-721トークンから転送されたときに発行されるイベント
  /// @param _fromContract トークンが転送された元のコントラクト
  /// @param _fromTokenId トークンが転送された元のトークン
  /// @param _amount 転送されたトークンの量
  event TransferFromParent(
    address indexed _fromContract, 
    uint256 indexed _fromTokenId, 
    uint256 _amount
  );

  /// @notice 非代替性の親トークンの残高を取得する
  /// @param _tokenContract 親トークンを追跡するコントラクト
  /// @param _tokenId 親トークンのID
  /// @return amount トークンの残高
  function balanceOfToken(
    address _tokenContract, 
    uint256 _tokenId
  )
    external
    view
    returns (uint256 amount);

  /// @notice トークンをオーナーアドレスからトークンに転送する
  /// @param _from オーナーアドレス
  /// @param _toContract 受け取るトークンのERC-721コントラクト
  /// @param _toToken 受け取るトークン
  /// @param _amount 転送するトークンの量
  function transferToParent(
    address _from, 
    address _toContract, 
    uint256 _toTokenId, 
    uint256 _amount
  )
    external;

  /// @notice トークンをトークンから別のアドレスに転送する
  /// @param _fromContract 所有コントラクトのアドレス
  /// @param _fromTokenId 所有トークン
  /// @param _to トークンが転送されるアドレス
  /// @param _amount 転送するトークンの量
  function transferFromParent(
    address _fromContract, 
    uint256 _fromTokenId, 
    address _to, 
    uint256 _amount
  )
    external;

  /// @notice トークンをトークンから別のアドレスに転送する。`ERC-223`のセマンティクスを使用する
  /// @param _fromContract 所有コントラクトのアドレス
  /// @param _fromTokenId 所有トークン
  /// @param _to トークンが転送されるアドレス
  /// @param _amount 転送するトークンの量
  /// @param _data 指定のフォーマットはない追加のデータ、送信者のトークンIDを指定できる
  function transferFromParentERC223(
    address _fromContract, 
    uint256 _fromTokenId, 
    address _to, 
    uint256 _amount, 
    bytes _data
  )
    external;

  /// @notice トークンをトークンから別のトークンに転送する
  /// @param _fromContract 所有コントラクトのアドレス
  /// @param _fromTokenId 所有トークン
  /// @param _toContract 受け取るトークンのERC-721コントラクト
  /// @param _toToken 受け取るトークン
  /// @param _amount 転送するトークンの量
  function transferAsChild(
    address _fromContract, 
    uint256 _fromTokenId, 
    address _toContract, 
    uint256 _toTokenId, 
    uint256 _amount
   )
    external;
}
```

#### balanceOfToken

```solidity
/// @notice 非代替性の親トークンの残高を取得する
/// @param _tokenContract 親トークンを追跡するコントラクト
/// @param _tokenId 親トークンのID
/// @return amount トークンの残高
function balanceOfToken(
  address _tokenContract, 
  uint256 _tokenId
)
  external
  view
  returns (uint256 amount);
```

この関数は、非代替性トークンの残高を返します。これは標準のERC-20メソッド`balanceOf`と同じ動作をしますが、親トークンのコントラクトアドレスとトークンIDを受け取ります。このメソッドは`balanceOf`と同じ動作をしますが、ユーザーアドレスではなくERC-721トークンの所有権を確認します。

#### `transferToParent`

```solidity
/// @notice トークンをオーナーアドレスからトークンに転送する
/// @param _from オーナーアドレス
/// @param _toContract 受け取るトークンのERC-721コントラクト
/// @param _toToken 受け取るトークン
/// @param _amount 転送するトークンの量
function transferToParent(
  address _from, 
  address _toContract, 
  uint256 _toTokenId, 
  uint256 _amount
)
  external;
```

この関数は、ユーザーアドレスからERC-721トークンにトークンを転送します。この関数は、受け取り側のコントラクトがERC-165の`supportsInterface`関数を使ってERC-721を実装していることを確認しなければなりません。この関数は、受け取りトークンが実際に存在することを、受け取りトークンのコントラクトの`ownerOf`を呼び出して確認し、スローしないことを確認しなければなりません。この関数は、成功した転送時に`TransferToParent`イベントを発行しなければなりません(標準のERC-20 `Transfer`イベントに加えて)。この関数は、`_from`アカウントの残高が`_amount`以上ない場合、スローしなければなりません。

#### `transferFromParent`

```solidity
/// @notice トークンをトークンから別のアドレスに転送する
/// @param _fromContract 所有コントラクトのアドレス
/// @param _fromTokenId 所有トークン
/// @param _to トークンが転送されるアドレス
/// @param _amount 転送するトークンの量
function transferFromParent(
  address _fromContract, 
  uint256 _fromTokenId, 
  address _to, 
  uint256 _amount
)
  external;
```

この関数は、ERC-721トークンからアドレスにトークンを転送します。この関数は、成功した転送時に`TransferFromParent`イベントを発行しなければなりません(標準のERC-20 `Transfer`イベントに加えて)。この関数は、送信側のERC-721トークンの残高が指定の`_amount`以上ない場合、スローしなければなりません。この関数は、`msg.sender`が送信側のERC-721トークンの所有者であることを確認し、そうでない場合はスローしなければなりません。

#### `transferFromParentERC223`

```solidity
/// @notice トークンをトークンから別のアドレスに転送する。`ERC-223`のセマンティクスを使用する
/// @param _fromContract 所有コントラクトのアドレス
/// @param _fromTokenId 所有トークン
/// @param _to トークンが転送されるアドレス
/// @param _amount 転送するトークンの量
/// @param _data 指定のフォーマットはない追加のデータ、送信者のトークンIDを指定できる
function transferFromParentERC223(
  address _fromContract, 
  uint256 _fromTokenId, 
  address _to, 
  uint256 _amount, 
  bytes _data
)
  external;
```

この関数は、ERC-721トークンからアドレスにトークンを転送します。この関数は`transferFromParent`と同じ要件を持ちますが、さらに`ERC-223`で指定されているように、受け取りアドレスがコントラクトの場合は`tokenFallback`を呼び出さなければなりません。

#### transferAsChild 1

```solidity
/// @notice トークンをトークンから別のトークンに転送する
/// @param _fromContract 所有コントラクトのアドレス
/// @param _fromTokenId 所有トークン
/// @param _toContract 受け取るトークンのERC-721コントラクト
/// @param _toToken 受け取るトークン
/// @param _amount 転送するトークンの量
function transferAsChild(
  address _fromContract, 
  uint256 _fromTokenId, 
  address _toContract,
uint256 _toTokenId, 
  uint256 _amount
)
  external;
```

この関数は、ERC-721トークンから別のERC-721トークンにトークンを転送します。この関数は、`TransferFromParent`と`TransferToParent`の両方のイベントを発行しなければなりません(標準のERC-20 `Transfer`イベントに加えて)。この関数は、送信側のERC-721トークンの残高が指定の`_amount`以上ない場合、スローしなければなりません。この関数は、`msg.sender`が送信側のERC-721トークンの所有者であることを確認し、そうでない場合はスローしなければなりません。この関数は、受け取り側のコントラクトがERC-165の`supportsInterface`関数を使ってERC-721を実装していることを確認しなければなりません。この関数は、受け取りトークンが実際に存在することを、受け取りトークンのコントラクトの`ownerOf`を呼び出して確認し、スローしないことを確認しなければなりません。

### 注意事項

後方互換性のために、実装は標準のERC-20 `Transfer`イベントを、送信者と受信者がアドレスかトークンかに関わらず、転送が発生した際に必ず発行しなければなりません。送信者または受信者がトークンの場合、`Transfer`イベントのパラメータにはトークンのコントラクトアドレスを使用する必要があります。

実装は、このインターフェースで指定された関数に加えて、すべてのERC-20および`ERC-223`関数を実装しなければなりません。

## 根拠

トップダウン型とボトムアップ型の2種類の合成可能トークンが存在するのは、異なるユースケースに対応するためです。通常のERC-721トークンはトップダウン型の合成可能トークンを所有できませんが、ボトムアップ型の合成可能トークンを所有できます。ボトムアップ型の合成可能トークンは通常のERC-721トークンを所有できませんが、トップダウン型の合成可能トークンは通常のERC-721トークンを所有できます。複数の種類の合成可能トークンを持つことで、さまざまなトークンの所有関係を表現できます。

### どの種類の合成可能トークンを使うべきか?

通常のERC-721トークンを非代替性トークンに転送したい場合は、トップダウン型の合成可能トークンを使用します。

非代替性トークンを通常のERC-721トークンに転送したい場合は、ボトムアップ型の合成可能トークンを使用します。

### 明示的な転送パラメータ

すべてのERC-998転送関数には、トークンの前の所有者と新しい所有者を明示的に指定するパラメータが含まれています。**from**と**to**を明示的に提供するのは、意図しない方法でトークンが転送されるような状況を避けるためです。

**from**が明示的に提供されていない場合に起こりうる例は以下の通りです:
> 取引所コントラクトが、ユーザーAとユーザーB、ユーザーCの特定の合成可能コントラクトで承認されたオペレーターです。
>
> ユーザーAがトークン1をユーザーBに転送します。同時に取引所コントラクトがトークン1をユーザーCに転送します(暗黙的にユーザーAから転送する意図)。ユーザーBがトークン1を1分所有した後、誤ってユーザーCに転送されます。2つ目の転送は**from**が明示的に提供されていないため、トークン1がユーザーAから来たことを確認できず、失敗しませんでした。

## 後方互換性

合成可能トークンは、ERC-721、`ERC-223`、ERC-20トークンと連携するように設計されています。

一部の古いERC-721コントラクトには`safeTransferFrom`関数がありません。その場合でも`getChild`関数を使ってERC-721トップダウン型の合成可能トークンにトークンを転送できます。

ERC-20コントラクトに`ERC-223`関数`transfer(address _to, uint _value, bytes _data)`がない場合は、`getERC20`関数を使ってERC-20トップダウン型の合成可能トークンにERC-20トークンを転送できます。

## 参考実装

実装例は以下にあります: `https://github.com/mattlockyer/composables-998`

## セキュリティ上の考慮事項

議論が必要です。


## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。