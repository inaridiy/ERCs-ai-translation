---
original: 5f6c0b9326d5d430c00dd484d5361d88cf91a98c85b905ee1c63d56651332b5f
---

---
eip: 2098
title: コンパクト署名表現
description: Ethereumの署名の簡潔な表現。
status: 最終
type: 標準トラック
category: ERC
author: Richard Moore (@ricmoo)、Nick Johnson <nick@ethereum.org>
discussions-to: https://github.com/ethereum/EIPs/issues/2440
created: 2019-03-14
requires: 2
---


## 概要

secp256k1曲線では、署名付きダイジェストと組み合わせることで、署名者の公開鍵を計算することができます。これは、外部所有アカウントからのトランザクションの発信元を確立するのに暗黙的に使用されており、メタトランザクションやマルチシグ契約などのオンチェーンEVMコントラクトでも使用されています。

現在、署名を表現するには65バイトが必要で、これを256ビットワードに合わせると96バイト(31バイトのゼロバイトが挿入される)になります。RLP符号化されたトランザクションのyParityにも(平均して)1.5バイトが必要です。コンパクト署名を使えば、これを64バイトに削減でき、ワード整列後も64バイトのままで、RLP符号化されたトランザクションの場合はyParityに必要な1.5バイトを節約できます。


## 動機

コンパクトな表現を採用する動機は、クライアントコードでのトランザクション処理の簡素化、ガスコストの削減、トランザクションサイズの縮小です。


## 仕様

secp256k1署名は3つのパラメータ、`r`、`s`、`yParity`で構成されています。`r`はカーブ上の`x`成分を表し(これから`y`が計算できる)、`s`は秘密鍵による署名の解答を表します。楕円曲線の対称性により、`yParity`が必要となり、これは2つの可能な解のうちどちらが意図されたかを示します。

コンパクトな表現を作るには2つの重要な観察が必要です。

1つ目は、`yParity`パラメータは常に0または1です(正規的には27と28の値が使われてきましたが、これらの値はビットコインで使われていた他のバイナリプレフィックスと衝突しませんでした)。

2つ目は、`s`パラメータの最上位ビットは**常に**0です。これは、[Homesteadで導入された制約](./eip-2.md)により、負の値を防ぐために解のパリティが反転されるためです。

そこで、`s`パラメータの最上位ビットを`yParity`の値を格納するために使うことができます。結果は以下のようになります:

```
[256ビットのr値][1ビットのyParity値][255ビットのs値]
```


### Pythonでの実装例

```python
# yParityは0または1、正規の27または28から正規化されているものとする
def to_compact(r, s, yParity):
    return {
        "r": r,
        "yParityAndS": (yParity << 255) | s
    }

def to_canonical(r, yParityAndS):
    return {
        "r": r,
        "s": yParityAndS & ((1 << 255) - 1),
        "yParity": (yParityAndS >> 255)
    }
```


## 根拠

提案されたコンパクトな表現は、クライアントやSolidityで簡単に構成・分解できるよう設計されており、トランザクションサイズとガスコストを削減しつつ、容易に(そして直感的に)サポートできるようになっています。


## 下位互換性

コンパクト表現は正規署名と衝突しません。正規署名は3つのパラメータ(r、s、yParity)を使い65バイトですが、コンパクト表現は2つのパラメータ(r、yParityAndS)を使い64バイトです。


## テストケース

```
秘密鍵: 0x1234567890123456789012345678901234567890123456789012345678901234
メッセージ: "Hello World"
署名:
  r:  0x68a020a209d3d56c46f38cc50a33f704f4a9a10a59377f8dd762ac66910e9b90
  s:  0x7e865ad05c4035ab5792787d4a0297a43617ae897930a6fe4d822b8faea52064
  v:  27
コンパクト署名:
  r:           0x68a020a209d3d56c46f38cc50a33f704f4a9a10a59377f8dd762ac66910e9b90
  yParityAndS: 0x7e865ad05c4035ab5792787d4a0297a43617ae897930a6fe4d822b8faea52064
```

```
秘密鍵: 0x1234567890123456789012345678901234567890123456789012345678901234
メッセージ: "It's a small(er) world"
署名:
  r:  0x9328da16089fcba9bececa81663203989f2df5fe1faa6291a45381c81bd17f76
  s:  0x139c6d6b623b42da56557e5e734a43dc83345ddfadec52cbe24d0cc64f550793
  v:  28
コンパクト署名:
  r:           0x9328da16089fcba9bececa81663203989f2df5fe1faa6291a45381c81bd17f76
  yParityAndS: 0x939c6d6b623b42da56557e5e734a43dc83345ddfadec52cbe24d0cc64f550793  
```


## 参考実装

ethers.jsライブラリのv5では[この機能をサポートしています](https://github.com/ethers-io/ethers.js/blob/ethers-v5-beta/packages/bytes/src.ts/index.ts#L323)が、これは非公式のプロパティ(`sig._vs`)であり、コミュニティの裁量によって変更される可能性があるため、このEIPの変更に合わせて考慮する必要があります。


## セキュリティ上の考慮事項

このEIPによって新たなセキュリティ上の懸念は生じません。


## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。